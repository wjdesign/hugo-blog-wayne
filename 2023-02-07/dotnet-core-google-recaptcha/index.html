<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="網站上幾乎每頁都有聯絡表單，並透過 AJAX 傳送到後端 API 負責記錄並送出郵件到公司的服務信箱，但網站上線後，垃圾訊息太常收到。因此，我打算將表單加入 Google Cloud Platform (GCP) 的 reCAPTCHA Enterprise 服務，減少收到垃圾訊息的機會，這篇文章我來分享一下完整的開發流程！"><meta name=keywords content="c#,csharp,dotnet,.net,google reCAPTCHA Enterprise,驗證機制,reCAPTCHA,google cloud platform,gcp"><title>ASP.NET Core 網站如何整合 Google 的 reCAPTCHA Enterprise 功能</title><link rel=canonical href=https://wayne-blog.com/2023-02-07/dotnet-core-google-recaptcha/><link rel=stylesheet href=https://wayne-blog.com/scss/style.min.e3f888c5dd2d8234c7284a9b45d1b5916903fb544644cac31c873b6488e8d7a0.css><script>!function(e,t,n,s,o,i,a){if(e.fbq)return;o=e.fbq=function(){o.callMethod?o.callMethod.apply(o,arguments):o.queue.push(arguments)},e._fbq||(e._fbq=o),o.push=o,o.loaded=!0,o.version="2.0",o.queue=[],i=t.createElement(n),i.async=!0,i.src=s,a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(i,a)}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js"),fbq("init","843131703668116"),fbq("track","PageView")</script><noscript><img height=1 width=1 style=display:none src="https://www.facebook.com/tr?id=843131703668116&ev=PageView&noscript=1"></noscript><meta property="og:title" content="ASP.NET Core 網站如何整合 Google 的 reCAPTCHA Enterprise 功能"><meta property="og:description" content="網站上幾乎每頁都有聯絡表單，並透過 AJAX 傳送到後端 API 負責記錄並送出郵件到公司的服務信箱，但網站上線後，垃圾訊息太常收到。因此，我打算將表單加入 Google Cloud Platform (GCP) 的 reCAPTCHA Enterprise 服務，減少收到垃圾訊息的機會，這篇文章我來分享一下完整的開發流程！"><meta property="og:url" content="https://wayne-blog.com/2023-02-07/dotnet-core-google-recaptcha/"><meta property="og:site_name" content="Wayne's blog | 偉恩的部落格 | 技術博客"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="csharp"><meta property="article:tag" content="dotnet-core"><meta property="article:tag" content="gcp"><meta property="article:published_time" content="2023-02-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-07T00:00:00+00:00"><meta property="og:image" content="https://live.staticflickr.com/65535/52674631510_d9525c3729_o.png"><meta name=twitter:site content="@4006wayne"><meta name=twitter:creator content="@4006wayne"><meta name=twitter:title content="ASP.NET Core 網站如何整合 Google 的 reCAPTCHA Enterprise 功能"><meta name=twitter:description content="網站上幾乎每頁都有聯絡表單，並透過 AJAX 傳送到後端 API 負責記錄並送出郵件到公司的服務信箱，但網站上線後，垃圾訊息太常收到。因此，我打算將表單加入 Google Cloud Platform (GCP) 的 reCAPTCHA Enterprise 服務，減少收到垃圾訊息的機會，這篇文章我來分享一下完整的開發流程！"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://live.staticflickr.com/65535/52674631510_d9525c3729_o.png"><link rel="shortcut icon" href=https://live.staticflickr.com/65535/52275825736_808b1fd4a8_o.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-FG6KQD7H6C"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FG6KQD7H6C",{anonymize_ip:!1})}</script><link rel=stylesheet type=text/css href=./toastify/style.min.css><script type=text/javascript src=./toastify/index.js></script><script>const hackKey="hack",author="Wayne (偉恩)",link="https://wayne-blog.com/",source="Wayne's blog | 偉恩的部落格 | 技術博客",warningText="請重視著作權，商業轉載請聯繫作者獲得授權，非商業轉載請註明出處。",warningBackgroundColor="linear-gradient(to right, rgb(108 47 87), rgb(191 86 86))",successBackgroundColor="linear-gradient(to right, rgb(47 151 127), rgb(69 195 137))",ignoreTagNames=["INPUT"];window.addEventListener("keyup",function(e){if(document.activeElement&&ignoreTagNames.includes(document.activeElement.tagName))return;if(e.key&&e.key.toLowerCase()==="h"){let e={text:"",duration:1e3,destination:"",newWindow:!0,close:!0,gravity:"top",position:"center",stopOnFocus:!1,style:{borderRadius:"50em"}};const t=new URL(window.location.href),n=new URLSearchParams(t.search);if(n.has(hackKey)){e.text="Hack模式已關閉",e.style.background=warningBackgroundColor,Toastify(e).showToast(),n.delete(hackKey),t.search=n.toString(),window.history.replaceState(null,"",t.toString());return}e.text="Hack模式已開啟",e.style.background=successBackgroundColor,Toastify(e).showToast(),n.set(hackKey,"1"),t.search=n.toString(),window.history.replaceState(null,"",t.toString())}}),window.addEventListener("copy",function(e){const t=new URL(window.location.href),n=new URLSearchParams(t.search);if(!n.has(hackKey)){e.preventDefault();const t=document.getSelection();e.clipboardData.setData("text/plain",`${t.toString()}

作者：${author}
連結：${link}
來源：${source}
${warningText}`)}})</script><style>:root{--zh-font-family:"Microsoft JhengHei", "微軟正黑體";--code-font-family:Menlo, Monaco, Consolas, "Courier New"}</style><meta name=theme-color content="#57BCB9"><link rel=manifest href=./manifest.json><link rel=apple-touch-icon sizes=57x57 href=./apple-touch-icon-57x57.webp><link rel=apple-touch-icon sizes=114x114 href=./apple-touch-icon-114x114.webp><link rel=apple-touch-icon sizes=120x120 href=./apple-touch-icon-120x120.webp><link rel=apple-touch-icon sizes=180x180 href=./apple-touch-icon-180x180.webp><link rel=apple-touch-icon sizes=192x192 href=./apple-touch-icon-192x192.webp><link rel=apple-touch-icon sizes=512x512 href=./apple-touch-icon-512x512.png><meta name=msvalidate.01 content="D1D0687C3DAA5A891295FC82A5EDD3B0"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=https://wayne-blog.com/><img src=https://wayne-blog.com/img/avatar2d.webp width=256 height=256 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🧧</span></figure><div class=site-meta><h1 class=site-name><a href=https://wayne-blog.com/>Wayne (偉恩)</a></h1><h2 class=site-description>軟體開發 | 網路工程 | 技術博客</h2></div></header><ol class=social-menu><li><a href=https://4006wayne.bobaboba.me target=_blank title=Bobaboba rel=me><svg width="16" height="25" viewBox="0 0 108 156" fill="none" xmlns="http://www.w3.org/2000/svg" class="ant-menu-item-icon"><g id="Frame" clip-path="url(#clip0_1286_9119)"><path id="Vector" d="M103.092 68.82c3.923-10.88 3.425-22.877-1.386-33.3898-4.8113-10.5128-13.5473-18.6939-24.3139-22.7695C66.6255 8.58519 54.6963 8.94396 44.1907 13.6589 33.6852 18.3738 25.4501 27.065 21.2715 37.848L103.092 68.82z" fill="#e3e7f5"/><path id="Vector_2" d="M20.6297 41.1675.0942412 133.077C-.0317631 133.774.0878744 134.493.432471 135.11.777068 135.727 1.325 136.203 1.98169 136.457L52.9429 155.789C53.6062 156.055 54.3425 156.073 55.0179 155.84 55.6933 155.607 56.2629 155.137 56.6233 154.517L101.337 71.7598C101.535 71.3808 101.649 70.9635 101.672 70.5363 101.694 70.109 101.626 69.6817 101.47 69.2836 101.314 68.8855 101.075 68.5258 100.769 68.2289 100.463 67.932 100.096 67.705 99.6951 67.5631L24.4802 39.0787C24.0918 38.9392 23.6786 38.8833 23.2674 38.9148 22.8561 38.9462 22.456 39.0642 22.093 39.2611S21.4122 39.7294 21.1601 40.0578 20.7273 40.7643 20.6297 41.1675z" fill="#f2f2f2"/><path id="Vector_3" d="M82.9934.252578 82.9758.245884C80.9074-.537125 78.5998.515063 77.8216 2.59602L48.9735 79.7314C48.1953 81.8123 49.2411 84.134 51.3094 84.917L51.3271 84.9237C53.3954 85.7067 55.703 84.6545 56.4813 82.5736L85.3293 5.43823C86.1076 3.35727 85.0618 1.03559 82.9934.252578z" fill="#ced8ed"/><path id="Vector_4" d="M104.866 63.6606 24.7538 33.3326C22.2172 32.3723 19.3869 33.6626 18.4324 36.2147L18.4258 36.2325C17.4713 38.7846 18.7541 41.632 21.2907 42.5923L101.403 72.9204C103.94 73.8806 106.77 72.5902 107.724 70.0381L107.731 70.0203C108.685 67.4682 107.403 64.6209 104.866 63.6606z" fill="#cbd3e8"/><path id="Vector_5" d="M89.6538 93.0834 56.7178 154.572C56.3574 155.192 55.7878 155.662 55.1124 155.895 54.437 156.129 53.7006 156.111 53.0374 155.844L2.07618 136.513C1.41948 136.259.87155 135.782.526954 135.165.182357 134.548.0627193 133.829.188724 133.133L15.4204 64.9219 89.6538 93.0834z" fill="#f8e0be"/><path id="Vector_6" d="M74.3088 11.125C77.2135 11.8219 79.9953 12.9619 82.5572 14.5052L69.2128 50.1868 60.2285 46.7876S74.6297 11.2579 74.3088 11.125z" fill="#e3e7f5"/><path id="Vector_7" d="M15.1374 125.272C17.7851 125.272 19.9315 123.112 19.9315 120.448 19.9315 117.784 17.7851 115.625 15.1374 115.625S10.3433 117.784 10.3433 120.448C10.3433 123.112 12.4897 125.272 15.1374 125.272z" fill="#d79b7a"/><path id="Vector_8" d="M15.3261 108.756C17.9738 108.756 20.1202 106.597 20.1202 103.933 20.1202 101.269 17.9738 99.1094 15.3261 99.1094S10.532 101.269 10.532 103.933C10.532 106.597 12.6784 108.756 15.3261 108.756z" fill="#d79b7a"/><path id="Vector_9" d="M23.0837 141.303c2.6477.0 4.7941-2.16 4.7941-4.82300000000001C27.8778 133.816 25.7314 131.656 23.0837 131.656S18.2896 133.816 18.2896 136.48C18.2896 139.143 20.436 141.303 23.0837 141.303z" fill="#d79b7a"/><path id="Vector_10" d="M58.9829 119.678c2.6477.0 4.7941-2.16 4.7941-4.82299999999999.0-2.664-2.1464-4.824-4.7941-4.824-2.6478.0-4.7942 2.16-4.7942 4.824C54.1887 117.518 56.3351 119.678 58.9829 119.678z" fill="#d79b7a"/><path id="Vector_11" d="M59.9643 138.022C62.612 138.022 64.7584 135.862 64.7584 133.198 64.7584 130.534 62.612 128.375 59.9643 128.375S55.1702 130.534 55.1702 133.198C55.1702 135.862 57.3166 138.022 59.9643 138.022z" fill="#d79b7a"/><path id="Vector_12" d="M41.3351 136.631C43.9829 136.631 46.1293 134.472 46.1293 131.808c0-2.66399999999999-2.1464-4.824-4.7942-4.824C38.6874 126.984 36.541 129.144 36.541 131.808 36.541 134.472 38.6874 136.631 41.3351 136.631z" fill="#d79b7a"/><path id="Vector_13" d="M50.5837 150.701C53.2314 150.701 55.3778 148.542 55.3778 145.878 55.3778 143.214 53.2314 141.055 50.5837 141.055S45.7896 143.214 45.7896 145.878C45.7896 148.542 47.936 150.701 50.5837 150.701z" fill="#d79b7a"/><path id="Vector_14" d="M35.7106 121.381C38.3584 121.381 40.5048 119.222 40.5048 116.558 40.5048 113.894 38.3584 111.734 35.7106 111.734 33.0629 111.734 30.9165 113.894 30.9165 116.558 30.9165 119.222 33.0629 121.381 35.7106 121.381z" fill="#d79b7a"/><path id="Vector_15" d="M68.8354 37.6381C67.5686 37.1053 66.5083 36.1721 65.8153 34.9795 65.7527 34.8551 65.7394 34.7115 65.778 34.5775 65.8165 34.4436 65.9042 34.3294 66.0231 34.2579 66.1435 34.1884 66.2861 34.1695 66.4203 34.205 66.5545 34.2405 66.6695 34.3277 66.7404 34.4477 66.7404 34.5996 68.7787 37.9797 72.0251 36.4985 72.0885 36.4533 72.1611 36.4229 72.2375 36.409 72.314 36.3952 72.3924 36.3984 72.4675 36.4185 72.5425 36.4387 72.6122 36.4755 72.6716 36.5259 72.731 36.5762 72.7785 36.6392 72.811 36.7102 72.8435 36.7812 72.86 36.8585 72.8594 36.9366 72.8588 37.0148 72.8409 37.0917 72.8073 37.1622 72.7737 37.2326 72.7251 37.2947 72.6649 37.3442 72.6047 37.3936 72.5345 37.429 72.4592 37.448 71.8991 37.7239 71.2894 37.8829 70.6666 37.9156 70.0439 37.9482 69.421 37.8539 68.8354 37.6381z" fill="#42210b"/><path id="Vector_16" d="M52.3767 34.5824c3.4921.0 6.3229-2.8481 6.3229-6.3615s-2.8308-6.3615-6.3229-6.3615-6.323 2.8481-6.323 6.3615 2.8309 6.3615 6.323 6.3615z" fill="#f2f2f2"/><path id="Vector_17" d="M46.3936 25.979C46.6783 25.1869 47.1165 24.4595 47.6829 23.8392 48.2493 23.2188 48.9326 22.7179 49.6929 22.3653 50.4533 22.0128 51.2757 21.8156 52.1124 21.7854 52.949 21.7551 53.7833 21.8922 54.5668 22.1889 55.3504 22.4857 56.0677 22.9361 56.6768 23.5139 57.286 24.0918 57.7751 24.7855 58.1157 25.555 58.4563 26.3245 58.6416 27.1543 58.6608 27.9964 58.6801 28.8385 58.5329 29.6761 58.2279 30.4605" fill="#51260e"/><path id="Vector_18" d="M53.4147 28.5224C53.2968 29.0523 53.0675 29.5504 52.742 29.9835 52.4164 30.4166 52.0024 30.7745 51.5277 31.0329 51.0531 31.2913 50.5289 31.4443 49.9905 31.4817 49.4521 31.519 48.9121 31.4396 48.4067 31.2492 47.9014 31.0587 47.4424 30.7614 47.0609 30.3773 46.6795 29.9933 46.3841 29.5315 46.1951 29.0229 46.0061 28.5143 45.9277 27.9709 45.9652 27.4292 46.0026 26.8875 46.1552 26.3602 46.4124 25.8828" fill="#47220d"/><path id="Vector_19" d="M87.4079 47.8559C90.9 47.8559 93.7309 45.0077 93.7309 41.4943 93.7309 37.981 90.9 35.1328 87.4079 35.1328c-3.492.0-6.3229 2.8482-6.3229 6.3615.0 3.5134 2.8309 6.3616 6.3229 6.3616z" fill="#f2f2f2"/><path id="Vector_20" d="M81.4246 39.2313C82.0304 37.6734 83.222 36.4183 84.741 35.7378 86.26 35.0572 87.9843 35.0059 89.5405 35.5952 91.0967 36.1845 92.3595 37.3671 93.0555 38.8864S93.8245 42.1397 93.2589 43.7129" fill="#51260e"/><path id="Vector_21" d="M88.446 41.8148C88.0132 42.6263 87.302 43.2519 86.445 43.5752 85.5879 43.8985 84.6434 43.8975 83.787 43.5724 82.9307 43.2473 82.2208 42.62 81.7897 41.8077 81.3586 40.9953 81.2355 40.0531 81.4434 39.1562" fill="#47220d"/></g><defs><clipPath id="clip0_1286_9119"><rect width="108" height="156" fill="#fff"/></clipPath></defs></svg></a></li><li><a href=https://www.facebook.com/wayne.blog.ga/ target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48" height="48"><linearGradient id="CXanuwD9EGkBgTn76_1mxa" x1="9.993" x2="40.615" y1="-299.993" y2="-330.615" gradientTransform="matrix(1 0 0 -1 0 -290)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#2aa4f4"/><stop offset="1" stop-color="#007ad9"/></linearGradient><path fill="url(#CXanuwD9EGkBgTn76_1mxa)" d="M24 4C12.954 4 4 12.954 4 24c0 10.028 7.379 18.331 17.004 19.777C21.981 43.924 22.982 41 24 41c.919.0 1.824 2.938 2.711 2.818C36.475 42.495 44 34.127 44 24 44 12.954 35.046 4 24 4z"/><path d="M27.707 21.169c0-1.424.305-3.121 1.757-3.121h4.283l-.001-5.617-.05-.852-.846-.114c-.608-.082-1.873-.253-4.206-.253-5.569.0-8.636 3.315-8.636 9.334v2.498H15.06v7.258h4.948V43.6C21.298 43.861 22.633 44 24 44c1.268.0 2.504-.131 3.707-.357V30.301h5.033l1.122-7.258h-6.155V21.169z" opacity=".05"/><path d="M27.207 21.169c0-1.353.293-3.621 2.257-3.621h3.783V12.46l-.026-.44-.433-.059c-.597-.081-1.838-.249-4.143-.249-5.323.0-8.136 3.055-8.136 8.834v2.998H15.56v6.258h4.948v13.874C21.644 43.876 22.806 44 24 44c1.094.0 2.16-.112 3.207-.281V29.801h5.104l.967-6.258h-6.072V21.169z" opacity=".05"/><path fill="#fff" d="M26.707 29.301h5.176l.813-5.258h-5.989v-2.874c0-2.184.714-4.121 2.757-4.121h3.283V12.46c-.577-.078-1.797-.248-4.102-.248-4.814.0-7.636 2.542-7.636 8.334v3.498H16.06v5.258h4.948v14.475C21.988 43.923 22.981 44 24 44c.921.0 1.82-.062 2.707-.182V29.301z"/></svg></a></li><li><a href=https://github.com/wjdesign target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/4006wayne target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=https://wayne-blog.com/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>關於本站</span></a></li><li><a href=https://wayne-blog.com/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>文章卷宗</span></a></li><li><a href=https://wayne-blog.com/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜尋檢索</span></a></li><li><a href=https://wayne-blog.com/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>相關連結</span></a></li><li><a href=https://wayne-blog.com/categories/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg><span>分類檢索</span></a></li><li><a href=https://wayne-blog.com/tags/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><span>標籤檢索</span></a></li><li><a href=https://wayne-blog.com/index.xml target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg><span>RSS Feed</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://wayne-blog.com/ selected>繁體中文</option><option value=https://wayne-blog.com/en/>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>夜晚模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#先整理幾個重要概念>先整理幾個重要概念</a></li><li><a href=#整合-recaptcha-enterprise-的大致流程>整合 reCAPTCHA Enterprise 的大致流程</a></li><li><a href=#申請-recaptcha-keys-階段>申請 reCAPTCHA keys 階段</a></li><li><a href=#收集前端使用者回應值階段>收集前端使用者回應值階段</a></li><li><a href=#後端評估與驗證回應值階段>後端評估與驗證回應值階段</a></li><li><a href=#總結>總結</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><a class=btnBack href=javascript:void(0) onclick=backEvent()><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-back" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9 11l-4 4 4 4m-4-4h11a4 4 0 000-8h-1"/></svg><span class=btnBackText>BACK</span></a>
<script>function backEvent(){if(document.referrer.indexOf(window.location.host)!==-1){history.go(-1);return}window.location.href=window.location.origin}</script><header class=article-header><div class=article-image><a href=https://wayne-blog.com/2023-02-07/dotnet-core-google-recaptcha/><img src=https://live.staticflickr.com/65535/52674631510_d9525c3729_o.png loading=lazy alt="Featured image of post ASP.NET Core 網站如何整合 Google 的 reCAPTCHA Enterprise 功能"></a></div><div class=article-details><header class=article-category><a href=https://wayne-blog.com/categories/csharp/ style=background-color:#68217a;color:#fff>C#</a>
<a href=https://wayne-blog.com/categories/dotnet-core/ style=background-color:#5c2d91;color:#fff>.NET Core</a>
<a href=https://wayne-blog.com/categories/gcp/ style=background-color:#fbbb17;color:#fff>Google Cloud Platform</a></header><div class=article-title-wrapper><h2 class=article-title><a href=https://wayne-blog.com/2023-02-07/dotnet-core-google-recaptcha/>ASP.NET Core 網站如何整合 Google 的 reCAPTCHA Enterprise 功能</a></h2><h3 class=article-subtitle>網站上幾乎每頁都有聯絡表單，並透過 AJAX 傳送到後端 API 負責記錄並送出郵件到公司的服務信箱，但網站上線後，垃圾訊息太常收到。因此，我打算將表單加入 Google Cloud Platform (GCP) 的 reCAPTCHA Enterprise 服務，減少收到垃圾訊息的機會，這篇文章我來分享一下完整的開發流程！</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 07, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>閱讀時間: 6 分鐘</time></div></footer></div></header><section class=article-content><style>.article-content p code{background-color:#f5f5f5;color:#ff3860}.focus{background:#f1e2e2;color:#d62c2c;padding:0 5px}</style><p><a class=link href=https://www.google.com/recaptcha/about/ target=_blank rel=noopener>參考網站</a><br><a class=link href=https://developers.google.com/recaptcha/intro target=_blank rel=noopener>參考網站</a><br><a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/choose-key-type target=_blank rel=noopener>參考網站</a><br><a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/how-to target=_blank rel=noopener>參考網站</a><br><a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/interpret-assessment target=_blank rel=noopener>參考網站</a><br><a class=link href=https://zh.wikipedia.org/wiki/ReCAPTCHA target=_blank rel=noopener>參考網站</a><br><a class=link href=https://ithelp.ithome.com.tw/articles/10262450 target=_blank rel=noopener>參考網站</a></p><p>網站上幾乎每頁都有聯絡表單，並透過 AJAX 傳送到後端 API 負責記錄並送出郵件到公司的服務信箱，但網站上線後，垃圾訊息太常收到。因此，我打算將表單加入 <a class=link href=https://cloud.google.com/ target=_blank rel=noopener>Google Cloud Platform</a> (GCP) 的 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 服務，減少收到垃圾訊息的機會，這篇文章我來分享一下完整的開發流程！</p><hr><h2 id=先整理幾個重要概念>先整理幾個重要概念</h2><p><a class=link href=https://zh.m.wikipedia.org/wiki/ReCAPTCHA target=_blank rel=noopener>reCAPTCHA</a> 原本是由<a class=link href=https://zh.m.wikipedia.org/wiki/%E5%8D%A1%E5%86%85%E5%9F%BA%C2%B7%E6%A2%85%E9%9A%86%E5%A4%A7%E5%AD%A6 target=_blank rel=noopener>卡內基梅隆大學</a>所發展的系統，主要目的是利用 <a class=link href=https://zh.m.wikipedia.org/wiki/CAPTCHA target=_blank rel=noopener>CAPTCHA</a> 技術來幫助典籍數位化的進行，這個計畫將由書本掃瞄下來無法準確的被光學文字辨識技術識別的文字顯示在 CAPTCHA 問題中，讓人類在回答 CAPTCHA 問題時用<strong>人腦</strong>加以識別。2009 年 9 月 17 日 Google 宣佈收購 reCAPTCHA 技術，持續發展之下也提供標準的 API 供用戶免費使用，時至今日已經發展出好幾個版本。</p><p>目前可以在 Google 網站找到 3 個不同的版本，其功能與特性各有不同：</p><ol><li><a class=link href=https://developers.google.com/recaptcha/docs/display target=_blank rel=noopener>reCAPTCHA v2</a></li></ol><p>除了原來的文字掃瞄圖片外，也採用 Google 街景拍攝的門牌號碼相片。</p><ol start=2><li><a class=link href=https://developers.google.com/recaptcha/docs/v3 target=_blank rel=noopener>reCAPTCHA v3</a></li></ol><p>採用<strong>分數制</strong>驗證系統，對使用者在網站上的動作進行評分，若分數過低則會被判定為機器人。</p><ol start=3><li><a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a></li></ol><p>與 <code>reCAPTCHA v3</code> 相同，採用<strong>分數制</strong>驗證系統，但能夠提供<strong>更精細的分數</strong>以及<strong>高風險分數原因代碼</strong>，以供進一步分析之用。</p><blockquote><p>本篇文章主要是以 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 為主，版本比較可參考 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/compare-versions target=_blank rel=noopener>Comparison of features between reCAPTCHA versions</a> 文件。</p></blockquote><p><a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 有個重要的概念，就是 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/keys target=_blank rel=noopener>reCAPTCHA keys</a> 或 <code>site keys</code>，我將其翻譯為「<strong>網站通關金鑰</strong>」或是「<strong>驗證金鑰</strong>」也許比較恰當，他是一個使用在你網站的一組公開金鑰，透過這個 <code>site keys</code> 會依據使用者端提供的各種資訊，自動產生一個唯一的「回應值」(Response)，你要把這個「回應值」傳到後端的 reCAPTCHA Server 進行驗證，由 reCAPTCHA Server 判斷出這個「回應值」是否是「真人」(Human)或「假人」(Bots)。</p><p><a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 的 <code>site keys</code> 有 3 種使用方式：</p><ol><li><strong>Score-based (no challenge) site keys</strong></li></ol><p>以「分數」為基礎的驗證方法，這種驗證方法完全<strong>不需要由使用輸入資訊</strong>，系統會自動判斷使用者透過瀏覽器、鍵盤或是觸控等使用方式，自動收集使用者跟手機或網頁之間的互動情況，判斷該「使用者」是否為「真人」或「假人」，送到 reCAPTCHA Server 驗證時，會提供你一個「分數」(Score)，從 <code>0.0</code> ～ <code>10.0</code> 分，其中 <code>0.0</code> 就是絕對的「假人」，而 <code>10.0</code> 就是絕對的「真人」。這種類型的 <code>site keys</code> 適用於「手機 APP」或「網頁」環境。</p><blockquote><p>這樣對使用者來說非常方便，不用讓客戶還在那邊選「哪幾張圖是公車」之類的，表單輸入門檻會低很多。</p></blockquote><ol start=2><li><strong>Checkbox (checkbox challenge) site keys</strong></li></ol><p>所謂 <code>Checkbox</code> 就真的是「核取方塊」的意思（如下圖示），他需要使用者真的去對這個 <code>Checkbox</code> 做個點擊的動作，藉此判斷跟網頁互動的對像是否為「真人」在操作。想當然的，這種驗證方式一定要跟使用者發生互動，所以只能用在「網頁」的介面上，尤其特別適合用在「表單填寫」、「網站登入」、「註冊會員」等網頁功能，但不適用於透過「手機 APP」或其他互動方式。</p><p><img src=https://live.staticflickr.com/65535/52673696102_3bffe38a83_o.gif max-width=100% max-height=100% class=gallery-image loading=lazy></p><blockquote><p>這種驗證方式可能不適用於所有情境，例如要提供「<strong>無障礙</strong>」網站的話，對「視覺」有問題的用戶就會很不方便，因此使用時要注意。詳見 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/choose-key-type#captcha-challenges target=_blank rel=noopener>Understanding the caveats with CAPTCHA challenges</a></p></blockquote><ol start=3><li><strong>reCAPTCHA WAF site keys</strong></li></ol><p>這個 reCAPTCHA WAF site keys 可以讓你把 sitekey 安裝在 WAF (應用程式防火牆) 這一層，但這種作法必須要合格的 WAF service provider 才能使用，例如 GCP 自家的 <a class=link href=https://cloud.google.com/armor target=_blank rel=noopener>Google Cloud Armor</a> 服務。詳情請見 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/integration-overview target=_blank rel=noopener>reCAPTCHA Enterprise for WAF and Google Cloud Armor integration overview</a> 說明。</p><hr><h2 id=整合-recaptcha-enterprise-的大致流程>整合 reCAPTCHA Enterprise 的大致流程</h2><p>想要整合 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 到你的網站，建議多少理解一下 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 的運作流程，你可以從 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/overview#how-recaptcha-enterprise-works target=_blank rel=noopener>How reCAPTCHA Enterprise works</a> 看到以下循序圖(sequence diagram)：</p><p><img src=https://live.staticflickr.com/65535/52673696092_e332ed9cc8_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>即便你大概知道這個流程，我還是覺得整合 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 有一點小門檻，所以我打算簡化成以下 3 個步驟來說明：</p><ol><li>申請 reCAPTCHA keys 階段</li></ol><p>你要到 <a class=link href=https://console.cloud.google.com/ target=_blank rel=noopener>Google Cloud console</a> 建立 <a class=link href=https://console.cloud.google.com/security/recaptcha target=_blank rel=noopener>reCAPTCHA keys</a></p><blockquote><p>也可以從 <a class=link href=https://console.cloud.google.com/ target=_blank rel=noopener>Google Cloud console</a> 左上角的<strong>漢堡選單</strong>選取 <code>Security</code> > <code>reCAPTCHA Enterprise</code> 進入此頁面。</p></blockquote><ol start=2><li>收集前端使用者回應值階段</li></ol><p>安裝 reCAPTCHA keys 到網頁上 (主要用來收集 reCAPTCHA 回應值)</p><ol start=3><li>後端評估與驗證回應值階段</li></ol><p>這個步驟會先從後端應用程式取得前端傳來的回應值，並將回應值送到 reCAPTCHA Server 進行評估(assessment)，並取得一個評估後的 Score (分數)，從該分數判斷這個 HTTP 要求是否要允許通過。</p><blockquote><p>此步驟最為麻煩，主因是缺少 ASP.NET Core 範例，所以上手確實有點門檻！</p></blockquote><p>以下我就依據這三個階段，分別說明作法！</p><hr><h2 id=申請-recaptcha-keys-階段>申請 reCAPTCHA keys 階段</h2><blockquote><p>可以參考 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/create-key target=_blank rel=noopener>Creating reCAPTCHA keys</a> 這份文件進行操作。</p></blockquote><ol><li><p>你要先有一個 <a class=link href=https://accounts.google.com/ target=_blank rel=noopener>Google 帳戶</a></p></li><li><p>在 Google Cloud Console <a class=link href=https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project target=_blank rel=noopener>建立一個新專案</a></p></li></ol><p><img src=https://live.staticflickr.com/65535/52674484149_6ce66d6192_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><ol start=3><li>啟用 <code>reCAPTCHA Enterprise API</code> 服務</li></ol><p>進入 <a class=link href=https://console.cloud.google.com/security/recaptcha target=_blank rel=noopener>reCAPTCHA Enterprise</a> 頁面，如果尚未啟用 <code>reCAPTCHA Enterprise API</code> 服務的話，會先出現以下畫面，你必須選對 GCP 上面的專案(Project)，然後按下 <code>ENABLE</code> 啟用服務：</p><p><img src=https://live.staticflickr.com/65535/52673696137_7386c9123f_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><ol start=4><li>建立 reCAPTCHA keys</li></ol><p>進入 <a class=link href=https://console.cloud.google.com/security/recaptcha target=_blank rel=noopener>reCAPTCHA Enterprise</a> 頁面</p><p><img src=https://live.staticflickr.com/65535/52674484179_2eec4888a1_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>輸入一個顯示名稱(<code>Display name</code>)與使用 reCAPTCHA keys 的平台(<code>Platform type</code>)，由於我們是一個網站服務，所以記得選擇 <code>Website</code> 選項</p><p><img src=https://live.staticflickr.com/65535/52674631195_2268de597c_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>如果是網站使用，就要設定網站的域名在此，你可以新增多個域名：</p><p><img src=https://live.staticflickr.com/65535/52674631220_9938c87bde_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>最後按下 <code>CREATE KEY</code> 建立即可。</p><p><img src=https://live.staticflickr.com/65535/52674192016_124de38d87_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><hr><h2 id=收集前端使用者回應值階段>收集前端使用者回應值階段</h2><p>我們從上一個步驟可以看到一個 <code>Web integration</code> 區段，這裡有一段 JavaScript 程式碼片段，你直接複製起來，貼上到網頁的 <code>&lt;head></code> 區段內，即可開始收集前端使用者回應值。</p><p>範例程式碼如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://www.google.com/recaptcha/enterprise.js?render=6LdSxPgjAAAAAGTKX703ydrWNF8WbQv2pZbRXGyX&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>grecaptcha</span><span class=p>.</span><span class=nx>enterprise</span><span class=p>.</span><span class=nx>ready</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>grecaptcha</span><span class=p>.</span><span class=nx>enterprise</span><span class=p>.</span><span class=nx>execute</span><span class=p>(</span><span class=s1>&#39;6LdSxPgjAAAAAGTKX703ydrWNF8WbQv2pZbRXGyX&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>action</span><span class=o>:</span> <span class=s1>&#39;login&#39;</span><span class=p>}).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>這裡特別需要知道的地方有以下幾點：</p><ol><li><p>程式碼片段的 <code>6LdSxPgjAAAAAGTKX703ydrWNF8WbQv2pZbRXGyX</code> 就是你的 <code>reCAPTCHA key</code></p></li><li><p>這裡的 <code>grecaptcha.enterprise.ready()</code> 函式會在載入完 reCAPTCHA Enterprise 函式庫後執行，只會執行一次</p></li><li><p>這裡的 <code>grecaptcha.enterprise.execute()</code> 函式則會執行 reCAPTCHA 驗證（這個函式會回傳一個 Promise 物件）</p></li><li><p>這裡的 <code>{ action: 'login'}</code> 也很重要，這裡是設定一個「驗證動作」的類型，這個值要跟後端進行驗證時使用相同的 <code>action</code> 才行<br>Google reCAPTCHA 的 <code>action</code> 參數可以是任何字串，它可以用來標記驗證的目的或類型。一些常用的 <code>action</code> 值包括：<code>login</code> (用於登入驗證)、<code>register</code> (用於註冊驗證)、<code>password_reset</code> (用於密碼重置驗證)、<code>contact</code> (用於聯繫表單驗證)，但其實沒有一定要用哪一種，不知道要挑哪一種的話，你隨便選個 <code>login</code> 其實都可以。</p></li><li><p>程式碼片段中的 <code>...</code> 不是真的程式碼，而是一個要你客製化修改的地方！<br>由於 <code>grecaptcha.enterprise.execute()</code> 函式是一個 Promise 物件，你可以透過 <code>.then()</code> 帶入的 function callback 得到一個 <code>token</code> 字串，這個就是由 reCAPTCHA Enterprise 幫你收集好的「回應值」，你要設法將這個值帶到後端去驗證。</p></li></ol><p>這裡有個地雷是，這個透過 <code>grecaptcha.enterprise.execute()</code> 函式取回的 <code>token</code> 有效期只有 <code>2 分鐘</code>！</p><p>各位~只有 <code>2</code> 分鐘就會<strong>過時</strong>/<strong>過期</strong>！只要 <code>2</code> 分鐘就會 <strong>Timeout</strong>！只要 2 分鐘就<strong>不能用</strong>了！</p><blockquote><p>很重要，所以說三遍，為了 SEO 要求，我用三份關鍵字描述！🔥</p></blockquote><p>超過 <code>2</code> 分鐘之後這個 <code>token</code> 就失效了，所以千萬不能在「<strong>網頁載入</strong>」的時候就取得 <code>token</code> 回應值，否則表單填寫超過 2 分鐘之後不就自動失效了嗎？這個注意事項是有出現在 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/create-assessment#retrieve_token target=_blank rel=noopener>Create an assessment</a> 官方文件中，我有點懷疑會有多少人看到？😅</p><p><img src=https://live.staticflickr.com/65535/52674631260_e53b2911b2_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><hr><h2 id=後端評估與驗證回應值階段>後端評估與驗證回應值階段</h2><p>這裡的步驟就有點多了，我會以 ASP.NET Core 6 為例進行解說完整步驟。</p><ol><li>到 Google Cloud Console 的 <a class=link href=https://console.cloud.google.com/iam-admin/serviceaccounts target=_blank rel=noopener>IAM & Admin > Service accounts</a> 建立一個服務帳戶(<code>Service Accounts</code>)</li></ol><p>要從網站的後端呼叫 GCP 上面的 API 服務，都需要有一個身分(Principal)來呼叫 API 服務。你可以從 <code>APIs & Services > Enabled APIs & Services</code> 找到 <code>reCAPTCHA Enterprise API</code> 服務，點擊進去：</p><p><img src=https://live.staticflickr.com/65535/52674631275_d9921c7606_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>我們要建立一個 reCAPTCHA Enterprise API 所需的 <code>CREDENTIALS</code> (身分認證)</p><p><img src=https://live.staticflickr.com/65535/52673696297_58025d471a_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>這裡有兩個選項，我們透過網站整合 reCAPTCHA Enterprise API 一定是使用 <code>Service Accounts</code> (服務帳戶) 這項！</p><p><img src=https://live.staticflickr.com/65535/52673696327_de9d0c8ac1_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>設定一個服務帳戶名稱，好記就好</p><p><img src=https://live.staticflickr.com/65535/52674695908_0e1455e917_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>🔥 <strong>這個步驟超級重要</strong>，你要是不在這裡選對 Role (角色)，也就是 <code>reCAPTCHA Enterprise Agent</code>，就算你取得 <code>Service Account</code> 也沒有權限呼叫 <code>reCAPTCHA Enterprise API</code>！</p><p><img src=https://live.staticflickr.com/65535/52673696372_5009fe8da3_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p><img src=https://live.staticflickr.com/65535/52674631365_1ebb8a6d4b_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>如果沒設定的話，你的 ASP.NET Core 執行時就會得到以下錯誤訊息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>Status</span><span class=p>(</span><span class=n>StatusCode</span><span class=p>=</span><span class=s>&#34;PermissionDenied&#34;</span><span class=p>,</span> <span class=n>Detail</span><span class=p>=</span><span class=s>&#34;Permission denied for: recaptchaenterprise.assessments.create. Please ensure you have sufficient permissions: https://cloud.google.com/iam/docs/granting-changing-revoking-access&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>這個步驟可以不用設定，直接按下 <code>DONE</code> 完成設定。</p><p><img src=https://live.staticflickr.com/65535/52673696422_6947c5edc3_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>點擊進入剛剛建立的服務帳戶</p><p><img src=https://live.staticflickr.com/65535/52674696068_f6abd56af7_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>🔥 切換到 <code>KEYS</code> 頁籤，建立一把新的<strong>私密金鑰</strong>(key)，主要用來給後端程式呼叫 API 時通過驗證用！</p><p><img src=https://live.staticflickr.com/65535/52674192246_6df4520a36_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>建立金鑰可以選擇兩種格式，我們選擇 <code>JSON</code> 格式</p><p><img src=https://live.staticflickr.com/65535/52674696038_3fa8ea1c95_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>🔥 按下 CREATE 之後，瀏覽器就會直接下載一個 *.json 檔案，這個檔案就是我們的金鑰檔，之後在 ASP.NET Core 網站中用的到！</p><p><img src=https://live.staticflickr.com/65535/52674631420_be947a72f5_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>這個 JSON 檔案的內容大致如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;service_account&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;project_id&#34;</span><span class=p>:</span> <span class=s2>&#34;recaptchademo-374714&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private_key_id&#34;</span><span class=p>:</span> <span class=s2>&#34;9462e07151d......181083e38c718503&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private_key&#34;</span><span class=p>:</span> <span class=s2>&#34;-----BEGIN PRIVATE KEY-----\nM...g=\n-----END PRIVATE KEY-----\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_email&#34;</span><span class=p>:</span> <span class=s2>&#34;myrecaptcha@recaptchademo-374714.iam.gserviceaccount.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_id&#34;</span><span class=p>:</span> <span class=s2>&#34;11581452......4955852&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;auth_uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://accounts.google.com/o/oauth2/auth&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://oauth2.googleapis.com/token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;auth_provider_x509_cert_url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://www.googleapis.com/oauth2/v1/certs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;client_x509_cert_url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://www.googleapis.com/robot/v1/metadata/x509/myrecaptcha%40recaptchademo-374714.iam.gserviceaccount.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>這個步驟我做了好幾次，漏掉一兩步就別想玩下去了，所以 GCP 就是主要的門檻所在！😅</p></blockquote><ol start=2><li>在 ASP.NET Core 網站安裝 <a class=link href=https://www.nuget.org/packages/Google.Cloud.RecaptchaEnterprise.V1 target=_blank rel=noopener>Google.Cloud.RecaptchaEnterprise.V1</a> NuGet 套件</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet add package Google.Cloud.RecaptchaEnterprise.V1
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>設定 ASP.NET Core 網站的 DI 容器 (ServiceCollection)</li></ol><p>以下程式碼會將 <code>RecaptchaEnterpriseServiceClient</code> 註冊成 Singleton，並設定 JsonCredentials 為我們剛剛下載的私密金鑰 JSON 檔！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddRecaptchaEnterpriseServiceClient</span><span class=p>(</span><span class=n>options</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>options</span><span class=p>.</span><span class=n>JsonCredentials</span> <span class=p>=</span> <span class=n>File</span><span class=p>.</span><span class=n>ReadAllText</span><span class=p>(</span><span class=s>&#34;recaptchademo-374714-9462e07151d4.json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>如果沒有指定 <code>Credentials</code> 的話，執行時就會得到以下錯誤訊息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>The Application Default Credentials are not available. They are available if running in Google Compute Engine. Otherwise, the environment variable GOOGLE_APPLICATION_CREDENTIALS must be defined pointing to a file defining the credentials. See https://developers.google.com/accounts/docs/application-default-credentials for more information.
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>在 Controller 的建構式注入 <code>RecaptchaEnterpriseServiceClient</code> 物件</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>private</span> <span class=k>readonly</span> <span class=n>RecaptchaEnterpriseServiceClient</span> <span class=n>_recaptchaClient</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>ContactController</span><span class=p>(</span><span class=n>RecaptchaEnterpriseServiceClient</span> <span class=n>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=n>_recaptchaClient</span> <span class=p>=</span> <span class=n>re</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>建立一個 <code>createAssessmentAsync</code> 方法 (Method)</li></ol><p>我參考 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/create-assessment#c target=_blank rel=noopener>Create an assessment using the REST API or Client Libraries</a> 的 C# 範例程式進行改寫如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=c1>// Create an assessment to analyze the risk of an UI action.</span>
</span></span><span class=line><span class=cl><span class=c1>// projectID: GCloud Project ID.</span>
</span></span><span class=line><span class=cl><span class=c1>// recaptchaSiteKey: Site key obtained by registering a domain/app to use recaptcha.</span>
</span></span><span class=line><span class=cl><span class=c1>// token: The token obtained from the client on passing the recaptchaSiteKey.</span>
</span></span><span class=line><span class=cl><span class=c1>// recaptchaAction: Action name corresponding to the token.</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>bool</span><span class=p>&gt;</span> <span class=n>createAssessmentAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kt>string</span> <span class=n>projectID</span> <span class=p>=</span> <span class=s>&#34;recaptchademo-374714&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kt>string</span> <span class=n>recaptchaSiteKey</span> <span class=p>=</span> <span class=s>&#34;6LdSxPgjAAAAAGTKX703ydrWNF8WbQv2pZbRXGyX&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kt>string</span> <span class=n>recaptchaAction</span> <span class=p>=</span> <span class=s>&#34;login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentException</span><span class=p>(</span><span class=s>&#34;The `token` argument must not empty.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ProjectName</span> <span class=n>projectName</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ProjectName</span><span class=p>(</span><span class=n>projectID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Build the assessment request.</span>
</span></span><span class=line><span class=cl>  <span class=n>CreateAssessmentRequest</span> <span class=n>createAssessmentRequest</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CreateAssessmentRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Assessment</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Assessment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Set the properties of the event to be tracked.</span>
</span></span><span class=line><span class=cl>      <span class=n>Event</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SiteKey</span> <span class=p>=</span> <span class=n>recaptchaSiteKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Token</span> <span class=p>=</span> <span class=n>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ExpectedAction</span> <span class=p>=</span> <span class=n>recaptchaAction</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>ParentAsProjectName</span> <span class=p>=</span> <span class=n>projectName</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Assessment</span> <span class=n>response</span> <span class=p>=</span> <span class=k>await</span> <span class=n>_recaptchaClient</span><span class=p>.</span><span class=n>CreateAssessmentAsync</span><span class=p>(</span><span class=n>createAssessmentRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Check if the token is valid.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>TokenProperties</span><span class=p>.</span><span class=n>Valid</span> <span class=p>==</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;The CreateAssessment call failed because the token was: &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>TokenProperties</span><span class=p>.</span><span class=n>InvalidReason</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Check if the expected action was executed.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=n>TokenProperties</span><span class=p>.</span><span class=n>Action</span> <span class=p>!=</span> <span class=n>recaptchaAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;The action attribute in reCAPTCHA tag is: &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>      <span class=n>response</span><span class=p>.</span><span class=n>TokenProperties</span><span class=p>.</span><span class=n>Action</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>_logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;The action attribute in the reCAPTCHA tag does not &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;match the action you are expecting to score&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Get the risk score and the reason(s).</span>
</span></span><span class=line><span class=cl>  <span class=c1>// For more information on interpreting the assessment,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// see: https://cloud.google.com/recaptcha-enterprise/docs/interpret-assessment</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>score</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>RiskAnalysis</span><span class=p>.</span><span class=n>Score</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>_logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;The reCAPTCHA score is: &#34;</span> <span class=p>+</span> <span class=n>score</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=n>RiskAnalysis</span><span class=p>.</span><span class=n>Types</span><span class=p>.</span><span class=n>ClassificationReason</span> <span class=n>reason</span> <span class=k>in</span> <span class=n>response</span><span class=p>.</span><span class=n>RiskAnalysis</span><span class=p>.</span><span class=n>Reasons</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=n>reason</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// https://developers.google.com/recaptcha/docs/analytics</span>
</span></span><span class=line><span class=cl>  <span class=c1>// This chart shows the average score on your site, which is designed to help you spot trends.</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Scores range from 0.0 to 1.0, with 0.0 indicating abusive traffic and 1.0 indicating good traffic.</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Sign up for reCAPTCHA v3 to gain more insights about your traffic.</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>score</span> <span class=p>&gt;</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>這裡 method 總共有 4 個參數，都很重要，除了 <code>token</code> 之外，其他都可以寫進 <code>appsettings.json</code> 組態之中！</p><p>因為 GCP 上的每個「專案」都有個唯一的 <code>projectID</code>，你要特別查才知道是什麼，這裡的 <code>projectID</code> 要記得到 <a class=link href=https://console.cloud.google.com/welcome target=_blank rel=noopener>https://console.cloud.google.com/welcome</a> 查閱！</p><p><img src=https://live.staticflickr.com/65535/52674484434_7414cca050_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>這裡的 <code>recaptchaSiteKey</code> 就是你先前建立 site key 時拿到的那組！</p><p><img src=https://live.staticflickr.com/65535/52674631405_347fa4a156_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><p>這裡的 <code>recaptchaAction</code> 必須跟你在「收集前端使用者回應值階段」設定的 <code>{action: 'login'}</code> 完全一樣，這裡是設定一個「驗證動作」的類型，可以是任意字串！</p><p>程式碼邏輯的部分我就不贅述了，大家可以自己看，應該很容易理解。最後的 <code>if (score > 0.5) {}</code> 就是在判斷怎樣的分數允許通過驗證，基本上分數只會介於 <code>0.0</code> ~ <code>1.0</code> 之間，共 11 個等級。但在尚未通過 <a class=link href=https://go.chronicle.security/recaptchaupgrade target=_blank rel=noopener>Google Security Review</a> 的前提下，預設只會有 <code>0.1</code>、<code>0.3</code>、<code>0.7</code> 與 <code>0.9</code> 這四個等級，所以建議 <code>Score</code> 結果的判斷式不要用 == 來寫，用 <code>&lt;</code>、<code>&lt;=</code> 或 <code>></code>、<code>>=</code> 才是比較正確的寫法！</p><ol start=6><li>最後要使用就很簡單了，以下是一個簡單的 Action 使用範例</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=na>[HttpPost]</span>
</span></span><span class=line><span class=cl><span class=na>[ValidateAntiForgeryToken]</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IActionResult</span><span class=p>&gt;</span> <span class=n>Index</span><span class=p>([</span><span class=n>FromForm</span><span class=p>]</span> <span class=n>ContactViewModel</span> <span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>await</span> <span class=n>createAssessmentAsync</span><span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=n>RecaptchaToken</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NoContent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>BadRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=總結>總結</h2><p>整合 Google 的 <a class=link href=https://cloud.google.com/recaptcha-enterprise target=_blank rel=noopener>reCAPTCHA Enterprise</a> 實在太多雷了，這對 <a class=link href=https://cloud.google.com/ target=_blank rel=noopener>Google Cloud Platform</a> 不太熟悉的人來說，整合起來著實有不小的門檻，本文這麼多步驟，要是我不記錄下來，過一段時間我肯定又忘記了！😅</p><p>我來重新總結一下整個開發過程：</p><ol><li>先到 <a class=link href=https://console.cloud.google.com/ target=_blank rel=noopener>Google Cloud console</a> 建立 <a class=link href=https://console.cloud.google.com/security/recaptcha target=_blank rel=noopener>reCAPTCHA keys</a><br>你可能需要<a class=link href=https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project target=_blank rel=noopener>建立一個新專案</a>，並啟用 <code>reCAPTCHA Enterprise API</code> 服務，然後才能建立 <a class=link href=https://console.cloud.google.com/security/recaptcha target=_blank rel=noopener>reCAPTCHA keys</a>。</li></ol><blockquote><p>每個 GCP 上面的新專案，都需要個別手動啟用 API 服務。如果你選用先前建立過的專案，且 <code>reCAPTCHA Enterprise API</code> 服務已經啟用過，那就不需要再次啟用。</p></blockquote><ol start=2><li><p>安裝 <a class=link href=https://cloud.google.com/recaptcha-enterprise/docs/keys target=_blank rel=noopener>reCAPTCHA keys</a> 到網頁上 (前端 JavaScript 為主)<br>這邊需要寫一點點 JavaScript 才能將 <code>token</code> 回寫到表單上，幫助前端將 <code>token</code> 送回後端評估。</p></li><li><p>從後端評估前端送來的 <code>token</code> (回應值) 是否有效<br>你必須建立一個 GCP 上的 <code>Service Account</code> (服務帳戶)，並賦予 <code>reCAPTCHA Enterprise Agent</code> 角色。然後為這個 <code>Service Account</code> 建立一把 <code>key</code> (私密金鑰) 才能組成一個 <code>Credential</code> (身分認證資訊) 讓應用程式使用，然後用這份 <code>Credential</code> 跟 <code>reCAPTCHA Enterprise API</code> 通訊，取得 <code>Assessment</code> (評估) 結果，然後依據 <code>Score</code> (分數) 判斷是否為真人的流量，通常這個 <code>Score</code> (分數) 只要大於等於 <code>0.7</code> 通常就意味著可信度夠高。</p></li></ol><p>另外，我想補充說明的是，<a class=link href=https://www.google.com/recaptcha/about/ target=_blank rel=noopener>reCAPTCHA Enterprise</a> 有<strong>每月 100 萬次免費使用額度</strong>，這些次數主要是「後端」對 <code>reCAPTCHA Enterprise API</code> 發送驗證 <code>Assessment</code> (評估) 的次數，對許多網站來說，這個數量應該是綽綽有餘了，所以我才考慮直接使用這個服務。</p><hr></section><footer class=article-footer><section class=article-tags><a href=https://wayne-blog.com/tags/csharp/>csharp</a>
<a href=https://wayne-blog.com/tags/dotnet-core/>dotnet-core</a>
<a href=https://wayne-blog.com/tags/gcp/>gcp</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=https://wayne-blog.com/2023-03-24/dotnet-core-v7-launch-profile/><div class=article-image><img src=https://live.staticflickr.com/65535/52767686731_8692b4f919_o.jpg loading=lazy data-key=dotnet-core-v7-launch-profile data-hash=https://live.staticflickr.com/65535/52767686731_8692b4f919_o.jpg></div><div class=article-details><h2 class=article-title>關於 ASP.NET Core 7.0 的啟動設定檔 (Launch Settings)</h2></div></a></article><article class=has-image><a href=https://wayne-blog.com/2023-02-24/webapi-3-tier-introduction/><div class=article-image><img src=https://live.staticflickr.com/65535/52708075740_5943652140_o.png loading=lazy data-key=webapi-3-tier-introduction data-hash=https://live.staticflickr.com/65535/52708075740_5943652140_o.png></div><div class=article-details><h2 class=article-title>【WebAPI】分層設計模式 - 三層式架構</h2></div></a></article><article class=has-image><a href=https://wayne-blog.com/2023-02-13/dotnet-core-debounce/><div class=article-image><img src=https://live.staticflickr.com/65535/52686405784_425f5b6fca_o.png loading=lazy data-key=dotnet-core-debounce data-hash=https://live.staticflickr.com/65535/52686405784_425f5b6fca_o.png></div><div class=article-details><h2 class=article-title>【C#】實作 Debounced Job</h2></div></a></article><article class=has-image><a href=https://wayne-blog.com/2022-12-09/dotnet-core-docker-note-4/><div class=article-image><img src=https://live.staticflickr.com/65535/52565101723_e9c2825542_o.png loading=lazy data-key=dotnet-core-docker-note-4 data-hash=https://live.staticflickr.com/65535/52565101723_e9c2825542_o.png></div><div class=article-details><h2 class=article-title>ASP.NET Core Docker 筆記 4 - ASP.NET Core 網站容器化經驗分享</h2></div></a></article><article class=has-image><a href=https://wayne-blog.com/2022-12-08/dotnet-core-docker-note-3/><div class=article-image><img src=https://live.staticflickr.com/65535/52565101723_e9c2825542_o.png loading=lazy data-key=dotnet-core-docker-note-3 data-hash=https://live.staticflickr.com/65535/52565101723_e9c2825542_o.png></div><div class=article-details><h2 class=article-title>ASP.NET Core Docker 筆記 3 - 共用 Nginx 容器與 Certbot 整合</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-blog-wayne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Wayne's blog | 偉恩的部落格 | 技術博客</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://wayne-blog.com/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&(console.log("Check service worker register?"),navigator.serviceWorker.register("./service-worker.js").then(function(){console.log("service worker registed.")}).catch(function(e){console.log("service worker registed fail. This happened: ",e)}));function toggleBtnScrollTop(){let t=document.documentElement.scrollTop||document.body.scrollTop;const e=document.getElementById("btnScrollTop");if(t){e&&!e.classList.contains("show")&&e.classList.add("show");return}e&&e.classList.contains("show")&&e.classList.remove("show")}window.addEventListener("scroll",toggleBtnScrollTop),document.addEventListener("DOMContentLoaded",toggleBtnScrollTop);function clickToScrollTop(){window.scrollTo({top:0,behavior:"smooth"})}function clickToMessenger(){window.open("//m.me/100278986238046","_blank")}</script><button id=btnScrollTop onclick=clickToScrollTop() title=回到頁頂>
<img src=https://wayne-blog.com/img/top_huf0c1dc16de3f1372c70e7aced5d60e6d_660_30x0_resize_box_3.png alt=scroll-top></button>
<button id=btnMessenger onclick=clickToMessenger() title="Facebook Messenger">
<img src=https://wayne-blog.com/img/messenger_hu3f63590c9d474cc4c51a145f9812597b_7669_50x0_resize_box_3.png alt="facebook messenger"></button></body></html>