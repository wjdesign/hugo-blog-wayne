<!doctype html><html lang=zh-tw dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Indexed Database API（簡稱IndexedDB，以前稱WebSimpleDB）是W3C推薦的一項網頁瀏覽器標準，是為提供一個具有索引的JSON物件集合的事務性本地資料庫操作介面。W3C於2015年1月8日發布了IndexedDB介面的最終建議。IndexedDB是一個嵌入在瀏覽器中的事務資料庫。該資料庫的管理圍繞JSON物件集合的概念，這類似NoSQL資料庫MongoDB與CouchDB。其中每個物件使用插入時生成的鍵標識。而索引系統最佳化對儲存物件的存取。"><meta name=keywords content="web browser,browser,indexeddb,web,websimpledb,database,frontend,indexedDB"><title>前端緩存大筆資料：IndexedDB 介紹/應用</title><link rel=canonical href=https://wayne-blog.com/2022-09-12/use-indexeddb/><link rel=stylesheet href=https://wayne-blog.com/scss/style.min.e3f888c5dd2d8234c7284a9b45d1b5916903fb544644cac31c873b6488e8d7a0.css><script>!function(e,t,n,s,o,i,a){if(e.fbq)return;o=e.fbq=function(){o.callMethod?o.callMethod.apply(o,arguments):o.queue.push(arguments)},e._fbq||(e._fbq=o),o.push=o,o.loaded=!0,o.version="2.0",o.queue=[],i=t.createElement(n),i.async=!0,i.src=s,a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(i,a)}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js"),fbq("init","843131703668116"),fbq("track","PageView")</script><noscript><img height=1 width=1 style=display:none src="https://www.facebook.com/tr?id=843131703668116&ev=PageView&noscript=1"></noscript><meta property="og:title" content="前端緩存大筆資料：IndexedDB 介紹/應用"><meta property="og:description" content="Indexed Database API（簡稱IndexedDB，以前稱WebSimpleDB）是W3C推薦的一項網頁瀏覽器標準，是為提供一個具有索引的JSON物件集合的事務性本地資料庫操作介面。W3C於2015年1月8日發布了IndexedDB介面的最終建議。IndexedDB是一個嵌入在瀏覽器中的事務資料庫。該資料庫的管理圍繞JSON物件集合的概念，這類似NoSQL資料庫MongoDB與CouchDB。其中每個物件使用插入時生成的鍵標識。而索引系統最佳化對儲存物件的存取。"><meta property="og:url" content="https://wayne-blog.com/2022-09-12/use-indexeddb/"><meta property="og:site_name" content="Wayne's blog | 偉恩的部落格 | 技術博客"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="indexedDB"><meta property="article:tag" content="web browser"><meta property="article:published_time" content="2022-09-12T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-12T00:00:00+00:00"><meta property="og:image" content="https://live.staticflickr.com/65535/52351840670_d321f7cc15_o.jpg"><meta name=twitter:site content="@4006wayne"><meta name=twitter:creator content="@4006wayne"><meta name=twitter:title content="前端緩存大筆資料：IndexedDB 介紹/應用"><meta name=twitter:description content="Indexed Database API（簡稱IndexedDB，以前稱WebSimpleDB）是W3C推薦的一項網頁瀏覽器標準，是為提供一個具有索引的JSON物件集合的事務性本地資料庫操作介面。W3C於2015年1月8日發布了IndexedDB介面的最終建議。IndexedDB是一個嵌入在瀏覽器中的事務資料庫。該資料庫的管理圍繞JSON物件集合的概念，這類似NoSQL資料庫MongoDB與CouchDB。其中每個物件使用插入時生成的鍵標識。而索引系統最佳化對儲存物件的存取。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://live.staticflickr.com/65535/52351840670_d321f7cc15_o.jpg"><link rel="shortcut icon" href=https://live.staticflickr.com/65535/52275825736_808b1fd4a8_o.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-FG6KQD7H6C"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FG6KQD7H6C",{anonymize_ip:!1})}</script><link rel=stylesheet type=text/css href=./toastify/style.min.css><script type=text/javascript src=./toastify/index.js></script><script>const hackKey="hack",author="Wayne (偉恩)",link="https://wayne-blog.com/",source="Wayne's blog | 偉恩的部落格 | 技術博客",warningText="請重視著作權，商業轉載請聯繫作者獲得授權，非商業轉載請註明出處。",warningBackgroundColor="linear-gradient(to right, rgb(108 47 87), rgb(191 86 86))",successBackgroundColor="linear-gradient(to right, rgb(47 151 127), rgb(69 195 137))",ignoreTagNames=["INPUT"];window.addEventListener("keyup",function(e){if(document.activeElement&&ignoreTagNames.includes(document.activeElement.tagName))return;if(e.key&&e.key.toLowerCase()==="h"){let e={text:"",duration:1e3,destination:"",newWindow:!0,close:!0,gravity:"top",position:"center",stopOnFocus:!1,style:{borderRadius:"50em"}};const t=new URL(window.location.href),n=new URLSearchParams(t.search);if(n.has(hackKey)){e.text="Hack模式已關閉",e.style.background=warningBackgroundColor,Toastify(e).showToast(),n.delete(hackKey),t.search=n.toString(),window.history.replaceState(null,"",t.toString());return}e.text="Hack模式已開啟",e.style.background=successBackgroundColor,Toastify(e).showToast(),n.set(hackKey,"1"),t.search=n.toString(),window.history.replaceState(null,"",t.toString())}}),window.addEventListener("copy",function(e){const t=new URL(window.location.href),n=new URLSearchParams(t.search);if(!n.has(hackKey)){e.preventDefault();const t=document.getSelection();e.clipboardData.setData("text/plain",`${t.toString()}

作者：${author}
連結：${link}
來源：${source}
${warningText}`)}})</script><style>:root{--zh-font-family:"Microsoft JhengHei", "微軟正黑體";--code-font-family:Menlo, Monaco, Consolas, "Courier New"}</style><meta name=theme-color content="#57BCB9"><link rel=manifest href=./manifest.json><link rel=apple-touch-icon sizes=57x57 href=./apple-touch-icon-57x57.webp><link rel=apple-touch-icon sizes=114x114 href=./apple-touch-icon-114x114.webp><link rel=apple-touch-icon sizes=120x120 href=./apple-touch-icon-120x120.webp><link rel=apple-touch-icon sizes=180x180 href=./apple-touch-icon-180x180.webp><link rel=apple-touch-icon sizes=192x192 href=./apple-touch-icon-192x192.webp><link rel=apple-touch-icon sizes=512x512 href=./apple-touch-icon-512x512.png><meta name=msvalidate.01 content="D1D0687C3DAA5A891295FC82A5EDD3B0"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=https://wayne-blog.com/><img src=https://wayne-blog.com/img/avatar2d.webp width=256 height=256 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🧧</span></figure><div class=site-meta><h1 class=site-name><a href=https://wayne-blog.com/>Wayne (偉恩)</a></h1><h2 class=site-description>軟體開發 | 網路工程 | 技術博客</h2></div></header><ol class=social-menu><li><a href=https://4006wayne.bobaboba.me target=_blank title=Bobaboba rel=me><svg width="16" height="25" viewBox="0 0 108 156" fill="none" xmlns="http://www.w3.org/2000/svg" class="ant-menu-item-icon"><g id="Frame" clip-path="url(#clip0_1286_9119)"><path id="Vector" d="M103.092 68.82c3.923-10.88 3.425-22.877-1.386-33.3898-4.8113-10.5128-13.5473-18.6939-24.3139-22.7695C66.6255 8.58519 54.6963 8.94396 44.1907 13.6589 33.6852 18.3738 25.4501 27.065 21.2715 37.848L103.092 68.82z" fill="#e3e7f5"/><path id="Vector_2" d="M20.6297 41.1675.0942412 133.077C-.0317631 133.774.0878744 134.493.432471 135.11.777068 135.727 1.325 136.203 1.98169 136.457L52.9429 155.789C53.6062 156.055 54.3425 156.073 55.0179 155.84 55.6933 155.607 56.2629 155.137 56.6233 154.517L101.337 71.7598C101.535 71.3808 101.649 70.9635 101.672 70.5363 101.694 70.109 101.626 69.6817 101.47 69.2836 101.314 68.8855 101.075 68.5258 100.769 68.2289 100.463 67.932 100.096 67.705 99.6951 67.5631L24.4802 39.0787C24.0918 38.9392 23.6786 38.8833 23.2674 38.9148 22.8561 38.9462 22.456 39.0642 22.093 39.2611S21.4122 39.7294 21.1601 40.0578 20.7273 40.7643 20.6297 41.1675z" fill="#f2f2f2"/><path id="Vector_3" d="M82.9934.252578 82.9758.245884C80.9074-.537125 78.5998.515063 77.8216 2.59602L48.9735 79.7314C48.1953 81.8123 49.2411 84.134 51.3094 84.917L51.3271 84.9237C53.3954 85.7067 55.703 84.6545 56.4813 82.5736L85.3293 5.43823C86.1076 3.35727 85.0618 1.03559 82.9934.252578z" fill="#ced8ed"/><path id="Vector_4" d="M104.866 63.6606 24.7538 33.3326C22.2172 32.3723 19.3869 33.6626 18.4324 36.2147L18.4258 36.2325C17.4713 38.7846 18.7541 41.632 21.2907 42.5923L101.403 72.9204C103.94 73.8806 106.77 72.5902 107.724 70.0381L107.731 70.0203C108.685 67.4682 107.403 64.6209 104.866 63.6606z" fill="#cbd3e8"/><path id="Vector_5" d="M89.6538 93.0834 56.7178 154.572C56.3574 155.192 55.7878 155.662 55.1124 155.895 54.437 156.129 53.7006 156.111 53.0374 155.844L2.07618 136.513C1.41948 136.259.87155 135.782.526954 135.165.182357 134.548.0627193 133.829.188724 133.133L15.4204 64.9219 89.6538 93.0834z" fill="#f8e0be"/><path id="Vector_6" d="M74.3088 11.125C77.2135 11.8219 79.9953 12.9619 82.5572 14.5052L69.2128 50.1868 60.2285 46.7876S74.6297 11.2579 74.3088 11.125z" fill="#e3e7f5"/><path id="Vector_7" d="M15.1374 125.272C17.7851 125.272 19.9315 123.112 19.9315 120.448 19.9315 117.784 17.7851 115.625 15.1374 115.625S10.3433 117.784 10.3433 120.448C10.3433 123.112 12.4897 125.272 15.1374 125.272z" fill="#d79b7a"/><path id="Vector_8" d="M15.3261 108.756C17.9738 108.756 20.1202 106.597 20.1202 103.933 20.1202 101.269 17.9738 99.1094 15.3261 99.1094S10.532 101.269 10.532 103.933C10.532 106.597 12.6784 108.756 15.3261 108.756z" fill="#d79b7a"/><path id="Vector_9" d="M23.0837 141.303c2.6477.0 4.7941-2.16 4.7941-4.82300000000001C27.8778 133.816 25.7314 131.656 23.0837 131.656S18.2896 133.816 18.2896 136.48C18.2896 139.143 20.436 141.303 23.0837 141.303z" fill="#d79b7a"/><path id="Vector_10" d="M58.9829 119.678c2.6477.0 4.7941-2.16 4.7941-4.82299999999999.0-2.664-2.1464-4.824-4.7941-4.824-2.6478.0-4.7942 2.16-4.7942 4.824C54.1887 117.518 56.3351 119.678 58.9829 119.678z" fill="#d79b7a"/><path id="Vector_11" d="M59.9643 138.022C62.612 138.022 64.7584 135.862 64.7584 133.198 64.7584 130.534 62.612 128.375 59.9643 128.375S55.1702 130.534 55.1702 133.198C55.1702 135.862 57.3166 138.022 59.9643 138.022z" fill="#d79b7a"/><path id="Vector_12" d="M41.3351 136.631C43.9829 136.631 46.1293 134.472 46.1293 131.808c0-2.66399999999999-2.1464-4.824-4.7942-4.824C38.6874 126.984 36.541 129.144 36.541 131.808 36.541 134.472 38.6874 136.631 41.3351 136.631z" fill="#d79b7a"/><path id="Vector_13" d="M50.5837 150.701C53.2314 150.701 55.3778 148.542 55.3778 145.878 55.3778 143.214 53.2314 141.055 50.5837 141.055S45.7896 143.214 45.7896 145.878C45.7896 148.542 47.936 150.701 50.5837 150.701z" fill="#d79b7a"/><path id="Vector_14" d="M35.7106 121.381C38.3584 121.381 40.5048 119.222 40.5048 116.558 40.5048 113.894 38.3584 111.734 35.7106 111.734 33.0629 111.734 30.9165 113.894 30.9165 116.558 30.9165 119.222 33.0629 121.381 35.7106 121.381z" fill="#d79b7a"/><path id="Vector_15" d="M68.8354 37.6381C67.5686 37.1053 66.5083 36.1721 65.8153 34.9795 65.7527 34.8551 65.7394 34.7115 65.778 34.5775 65.8165 34.4436 65.9042 34.3294 66.0231 34.2579 66.1435 34.1884 66.2861 34.1695 66.4203 34.205 66.5545 34.2405 66.6695 34.3277 66.7404 34.4477 66.7404 34.5996 68.7787 37.9797 72.0251 36.4985 72.0885 36.4533 72.1611 36.4229 72.2375 36.409 72.314 36.3952 72.3924 36.3984 72.4675 36.4185 72.5425 36.4387 72.6122 36.4755 72.6716 36.5259 72.731 36.5762 72.7785 36.6392 72.811 36.7102 72.8435 36.7812 72.86 36.8585 72.8594 36.9366 72.8588 37.0148 72.8409 37.0917 72.8073 37.1622 72.7737 37.2326 72.7251 37.2947 72.6649 37.3442 72.6047 37.3936 72.5345 37.429 72.4592 37.448 71.8991 37.7239 71.2894 37.8829 70.6666 37.9156 70.0439 37.9482 69.421 37.8539 68.8354 37.6381z" fill="#42210b"/><path id="Vector_16" d="M52.3767 34.5824c3.4921.0 6.3229-2.8481 6.3229-6.3615s-2.8308-6.3615-6.3229-6.3615-6.323 2.8481-6.323 6.3615 2.8309 6.3615 6.323 6.3615z" fill="#f2f2f2"/><path id="Vector_17" d="M46.3936 25.979C46.6783 25.1869 47.1165 24.4595 47.6829 23.8392 48.2493 23.2188 48.9326 22.7179 49.6929 22.3653 50.4533 22.0128 51.2757 21.8156 52.1124 21.7854 52.949 21.7551 53.7833 21.8922 54.5668 22.1889 55.3504 22.4857 56.0677 22.9361 56.6768 23.5139 57.286 24.0918 57.7751 24.7855 58.1157 25.555 58.4563 26.3245 58.6416 27.1543 58.6608 27.9964 58.6801 28.8385 58.5329 29.6761 58.2279 30.4605" fill="#51260e"/><path id="Vector_18" d="M53.4147 28.5224C53.2968 29.0523 53.0675 29.5504 52.742 29.9835 52.4164 30.4166 52.0024 30.7745 51.5277 31.0329 51.0531 31.2913 50.5289 31.4443 49.9905 31.4817 49.4521 31.519 48.9121 31.4396 48.4067 31.2492 47.9014 31.0587 47.4424 30.7614 47.0609 30.3773 46.6795 29.9933 46.3841 29.5315 46.1951 29.0229 46.0061 28.5143 45.9277 27.9709 45.9652 27.4292 46.0026 26.8875 46.1552 26.3602 46.4124 25.8828" fill="#47220d"/><path id="Vector_19" d="M87.4079 47.8559C90.9 47.8559 93.7309 45.0077 93.7309 41.4943 93.7309 37.981 90.9 35.1328 87.4079 35.1328c-3.492.0-6.3229 2.8482-6.3229 6.3615.0 3.5134 2.8309 6.3616 6.3229 6.3616z" fill="#f2f2f2"/><path id="Vector_20" d="M81.4246 39.2313C82.0304 37.6734 83.222 36.4183 84.741 35.7378 86.26 35.0572 87.9843 35.0059 89.5405 35.5952 91.0967 36.1845 92.3595 37.3671 93.0555 38.8864S93.8245 42.1397 93.2589 43.7129" fill="#51260e"/><path id="Vector_21" d="M88.446 41.8148C88.0132 42.6263 87.302 43.2519 86.445 43.5752 85.5879 43.8985 84.6434 43.8975 83.787 43.5724 82.9307 43.2473 82.2208 42.62 81.7897 41.8077 81.3586 40.9953 81.2355 40.0531 81.4434 39.1562" fill="#47220d"/></g><defs><clipPath id="clip0_1286_9119"><rect width="108" height="156" fill="#fff"/></clipPath></defs></svg></a></li><li><a href=https://www.facebook.com/wayne.blog.ga/ target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48" height="48"><linearGradient id="CXanuwD9EGkBgTn76_1mxa" x1="9.993" x2="40.615" y1="-299.993" y2="-330.615" gradientTransform="matrix(1 0 0 -1 0 -290)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#2aa4f4"/><stop offset="1" stop-color="#007ad9"/></linearGradient><path fill="url(#CXanuwD9EGkBgTn76_1mxa)" d="M24 4C12.954 4 4 12.954 4 24c0 10.028 7.379 18.331 17.004 19.777C21.981 43.924 22.982 41 24 41c.919.0 1.824 2.938 2.711 2.818C36.475 42.495 44 34.127 44 24 44 12.954 35.046 4 24 4z"/><path d="M27.707 21.169c0-1.424.305-3.121 1.757-3.121h4.283l-.001-5.617-.05-.852-.846-.114c-.608-.082-1.873-.253-4.206-.253-5.569.0-8.636 3.315-8.636 9.334v2.498H15.06v7.258h4.948V43.6C21.298 43.861 22.633 44 24 44c1.268.0 2.504-.131 3.707-.357V30.301h5.033l1.122-7.258h-6.155V21.169z" opacity=".05"/><path d="M27.207 21.169c0-1.353.293-3.621 2.257-3.621h3.783V12.46l-.026-.44-.433-.059c-.597-.081-1.838-.249-4.143-.249-5.323.0-8.136 3.055-8.136 8.834v2.998H15.56v6.258h4.948v13.874C21.644 43.876 22.806 44 24 44c1.094.0 2.16-.112 3.207-.281V29.801h5.104l.967-6.258h-6.072V21.169z" opacity=".05"/><path fill="#fff" d="M26.707 29.301h5.176l.813-5.258h-5.989v-2.874c0-2.184.714-4.121 2.757-4.121h3.283V12.46c-.577-.078-1.797-.248-4.102-.248-4.814.0-7.636 2.542-7.636 8.334v3.498H16.06v5.258h4.948v14.475C21.988 43.923 22.981 44 24 44c.921.0 1.82-.062 2.707-.182V29.301z"/></svg></a></li><li><a href=https://github.com/wjdesign target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/4006wayne target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=https://wayne-blog.com/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>關於本站</span></a></li><li><a href=https://wayne-blog.com/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>文章卷宗</span></a></li><li><a href=https://wayne-blog.com/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜尋檢索</span></a></li><li><a href=https://wayne-blog.com/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>相關連結</span></a></li><li><a href=https://wayne-blog.com/categories/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg><span>分類檢索</span></a></li><li><a href=https://wayne-blog.com/tags/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><span>標籤檢索</span></a></li><li><a href=https://wayne-blog.com/index.xml target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg><span>RSS Feed</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://wayne-blog.com/ selected>繁體中文</option><option value=https://wayne-blog.com/en/>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>夜晚模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#indexeddb-介紹>IndexedDB 介紹</a></li><li><a href=#相容性>相容性</a></li><li><a href=#儲存限制>儲存限制</a></li><li><a href=#資料鍵key>資料鍵(Key)</a></li><li><a href=#基本操作步驟>基本操作步驟</a><ol><li><ol><li></li></ol></li></ol></li><li><a href=#使用方式>使用方式</a><ol><li><a href=#1-試驗瀏覽器的前綴標示>1. 試驗瀏覽器的前綴標示</a><ol><li></li></ol></li><li><a href=#2-開啟資料庫>2. 開啟資料庫</a></li><li><a href=#3-使用資料鍵產生器>3. 使用資料鍵產生器</a><ol><li></li></ol></li><li><a href=#4-新增和刪除資料>4. 新增和刪除資料</a><ol><li></li></ol></li><li><a href=#5-移除資料>5. 移除資料</a><ol><li></li></ol></li><li><a href=#6-讀取資料>6. 讀取資料</a><ol><li></li></ol></li><li><a href=#7-使用指標cursor>7. 使用指標(Cursor)</a><ol><li></li></ol></li><li><a href=#8-使用索引>8. 使用索引</a></li><li><a href=#9-設定指標查詢範圍和方向>9. 設定指標查詢範圍和方向</a><ol><li></li></ol></li></ol></li><li><a href=#安全性>安全性</a></li><li><a href=#瀏覽器關閉風險>瀏覽器關閉風險</a><ol><li><ol><li></li></ol></li></ol></li><li><a href=#範例練習將聊天室推播訊息寫進-indexeddb>範例練習：將聊天室推播訊息寫進 IndexedDB</a><ol><li><ol><li></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><a class=btnBack href=javascript:void(0) onclick=backEvent()><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-back" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9 11l-4 4 4 4m-4-4h11a4 4 0 000-8h-1"/></svg><span class=btnBackText>BACK</span></a>
<script>function backEvent(){if(document.referrer.indexOf(window.location.host)!==-1){history.go(-1);return}window.location.href=window.location.origin}</script><header class=article-header><div class=article-image><a href=https://wayne-blog.com/2022-09-12/use-indexeddb/><img src=https://live.staticflickr.com/65535/52351840670_d321f7cc15_o.jpg loading=lazy alt="Featured image of post 前端緩存大筆資料：IndexedDB 介紹/應用"></a></div><div class=article-details><header class=article-category><a href=https://wayne-blog.com/categories/web-browser/ style=background-color:#655a9f;color:#fff>Web Browser</a></header><div class=article-title-wrapper><h2 class=article-title><a href=https://wayne-blog.com/2022-09-12/use-indexeddb/>前端緩存大筆資料：IndexedDB 介紹/應用</a></h2><h3 class=article-subtitle>Indexed Database API（簡稱IndexedDB，以前稱WebSimpleDB）是W3C推薦的一項網頁瀏覽器標準，是為提供一個具有索引的JSON物件集合的事務性本地資料庫操作介面。W3C於2015年1月8日發布了IndexedDB介面的最終建議。IndexedDB是一個嵌入在瀏覽器中的事務資料庫。該資料庫的管理圍繞JSON物件集合的概念，這類似NoSQL資料庫MongoDB與CouchDB。其中每個物件使用插入時生成的鍵標識。而索引系統最佳化對儲存物件的存取。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 12, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>閱讀時間: 7 分鐘</time></div></footer></div></header><section class=article-content><style>.focus{background:#f1e2e2;color:#d62c2c;padding:0 5px}</style><p><a class=link href=https://www.yasssssblog.com/2020/08/19/web-indexeddb/ target=_blank rel=noopener>參考網站1</a><br><a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/API/IndexedDB_API/Using_IndexedDB target=_blank rel=noopener>參考網站2</a></p><hr><h2 id=indexeddb-介紹>IndexedDB 介紹</h2><ul><li><code>key-value</code> 的儲存形式，透過索引功能來高效率搜尋資料。</li><li><a class=link href=https://www.w3.org/Security/wiki/Same_Origin_Policy target=_blank rel=noopener><code>同源政策 same-origin policy</code></a>：只能取用同網域下的資料。</li><li><code>Async API</code> : 提供非同步 api，單線程的應用下取用資料時就不會有 block the main thread 的情況造成使用者體驗不佳。</li><li><code>transaction</code> : 能夠確保大量寫入資料時的完整性，如果有單筆資料寫入失敗會全數 rollback。</li></ul><hr><h2 id=相容性>相容性</h2><ul><li>大部分的瀏覽器都已經支援使用，參閱：<a class=link href="https://caniuse.com/#feat=indexeddb" target=_blank rel=noopener>When Can I Use IndexedDB</a></li></ul><p><img src=https://live.staticflickr.com/65535/52351854285_c7b2ca3fda_o.png max-width=100% max-height=100% class=gallery-image loading=lazy></p><hr><h2 id=儲存限制>儲存限制</h2><p>單一資料庫項目的容量/大小並沒有任何限制，但是各個 IndexedDB資料庫的容量就有限制，且根據各瀏覽器其限制會不同。</p><ul><li>Chrome：允許瀏覽器使用多達總磁盤空間的60％。 您可以使用StorageManager API來確定可用的最大配額。 其他基於Chromium的瀏覽器可能允許該瀏覽器使用更多存儲空間。</li><li>Internet Explorer 10 和更高版本：最多可以存儲250MB，並且在使用了10MB以上時將提示用戶。</li><li>Firefox：允許一個來源最多使用2GB。 您可以使用StorageManager API來確定仍有多少可用空間。</li><li>Safari (both desktop and mobile) 似乎最多可容納1GB，達到限制後，Safari會提示用戶，以200MB為增量增加限制。</li></ul><p>refer to <a class=link href=https://web.dev/storage-for-the-web/ target=_blank rel=noopener>storage-for-the-web</a></p><hr><h2 id=資料鍵key>資料鍵(Key)</h2><ul><li>data type: string, date, float和 array</li><li>必須是能排序的值(<span class=focus>無法處理多國語言字串排序</span>)</li><li>物件存檔有三種方式產生資料鍵: <code>資料鍵產生器 (key generator)</code>、<code>資料鍵路徑 (key path)</code> 以及<code>指定值</code>。</li><li><code>資料鍵產生器 (key generator)</code>：用產生器自動產生資料鍵。</li><li><code>資料鍵路徑 (key path)</code>：空字串或是javascript identifier（包含用 &ldquo;.&rdquo; 分隔符號的名稱）且路徑不能有空白 (實測過中文會被轉成空字串)。</li></ul><hr><h2 id=基本操作步驟>基本操作步驟</h2><h5 id=操作indexeddb的基本步驟建議如下>操作IndexedDB的基本步驟建議如下：</h5><ol><li>開啟資料庫和交易(transaction)</li><li>建立物件存檔(object store)</li><li>發出資料庫操作請求，例如新增或取得資料</li><li>聆聽對應DOM事件等待操作完成</li><li>從result物件上取得結果進行其他工作</li></ol><hr><h2 id=使用方式>使用方式</h2><h3 id=1-試驗瀏覽器的前綴標示>1. 試驗瀏覽器的前綴標示</h3><ul><li>如果需要試驗瀏覽器的前綴標示，可以如下：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// In the following line, you should include the prefixes of implementations you want to test.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>indexedDB</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>indexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>mozIndexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>webkitIndexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>msIndexedDB</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// DON&#39;T use &#34;var indexedDB = ...&#34; if you&#39;re not in a function.
</span></span></span><span class=line><span class=cl><span class=c1>// Moreover, you may need references to some window.IDB* objects:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>IDBTransaction</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>IDBTransaction</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>webkitIDBTransaction</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>msIDBTransaction</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>IDBKeyRange</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>IDBKeyRange</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>webkitIDBKeyRange</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>msIDBKeyRange</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// (Mozilla has never prefixed these objects, so we don&#39;t need window.mozIDB*)
</span></span></span></code></pre></td></tr></table></div></div><h5 id=請注意瀏覽器前綴標示的實作可能不完整有些問題或仍然遵守舊版標準因此不建議在正式版程式碼中使用與其宣稱支援又有問題倒不如直接不支援>請注意瀏覽器前綴標示的實作可能不完整、有些問題或仍然遵守舊版標準，因此不建議在正式版程式碼中使用。與其宣稱支援又有問題，倒不如直接不支援。</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nb>window</span><span class=p>.</span><span class=nx>indexedDB</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Your browser doesn&#39;t support a stable version of IndexedDB. Such and such feature will not be available.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-開啟資料庫>2. 開啟資料庫</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Let us open database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>request</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>indexedDB</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s2>&#34;DB名稱&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do something with request.errorCode!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do something with request.result!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>開啟請求並不會立刻開啟資料庫或交易，呼叫<code>open()</code>方法會回傳一個<a class=link href=https://developer.mozilla.org/en-US/docs/IndexedDB/IDBOpenDBRequest target=_blank rel=noopener>IDBOpenDBRequest</a>物件，這個物件擁有兩個事件(<code>success</code> 和 <code>error</code>)。大部分IndexedDB的非同步功能都會回傳一個<a class=link href=https://developer.mozilla.org/en-US/docs/IndexedDB/IDBDatabase target=_blank rel=noopener>IDBDatabase</a>類物件，然後我們可以註冊成功和失敗事件處理器。</li><li><code>.open()</code>方法第二個參數是資料庫版本，資料庫版本決定了資料庫結構，也就是資料庫物件存檔的結構。如果請求版本不存在(比如因為這是一個新資料庫或是資料庫版本已升級)，<code>onupgradeneeded</code>事件會被觸發，然後我們可以在<code>onupgradeneeded</code>事件處理器中再建立新的版本，下面<a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/API/IndexedDB_API/Using_IndexedDB#Updating_the_version_of_the_database target=_blank rel=noopener>升級資料庫版本</a>有更詳細的說明。</li></ul><h3 id=3-使用資料鍵產生器>3. 使用資料鍵產生器</h3><ul><li>當建立物件存檔時設定<code>autoIncrement</code>旗標為<code>ture</code>將啟動資料鍵產生器，預設上該旗標為<code>false</code>。</li><li>有了資料鍵產生器，當新增資料到物件存檔中，資料鍵產生器會自動幫我們產生資料鍵。資料鍵產生器產生的資料鍵由整數1開始，而基本上新產生的資料鍵是由前一個資料鍵加1產生。資料鍵的產生不會因為資料刪除或清空所有資料而重新開始起算，所以資料鍵值是一直累加上去的，除非資料庫操作中斷，整個交易作業被取消。</li></ul><h5 id=我們可以建立一個有資料鍵產生器的物件存檔如下>我們可以建立一個有資料鍵產生器的物件存檔如下：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Open the indexedDB.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>indexedDB</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>dbName</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onupgradeneeded</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Create another object store called &#34;names&#34; with the autoIncrement flag set as true.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>objStore</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>createObjectStore</span><span class=p>(</span><span class=s2>&#34;names&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>autoIncrement</span> <span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Because the &#34;names&#34; object store has the key generator, the key for the name value is generated automatically.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The added records would be like:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// key : 1 =&gt; value : &#34;Bill&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// key : 2 =&gt; value : &#34;Donna&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=k>in</span> <span class=nx>customerData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>objStore</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>customerData</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>關於資料鍵產生器細節，請參考<a class=link href=http://www.w3.org/TR/IndexedDB/#key-generator-concept target=_blank rel=noopener>&ldquo;W3C Key Generators&rdquo;</a>。</p><h3 id=4-新增和刪除資料>4. 新增和刪除資料</h3><ul><li>在操作資料庫之前必須要先進行交易，交易來自資料庫物件，在交易中要指定涵蓋物件存檔範圍，然後也要決定是要變更資料庫或純粹讀取資料。</li><li>交易共有三種種類，分別是讀取(read-only)，讀寫(read/write), 以及版本變更(versionchange)，如果只需要讀資料最好只使用讀取(read-only)交易，因為讀取(read-only)交易可以多重同步進行。</li></ul><h5 id=創建資料庫後如果要寫入資料請這麼做>創建資料庫後，如果要寫入資料請這麼做：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>transaction</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;customers&#34;</span><span class=p>],</span> <span class=s2>&#34;readwrite&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Note: Older experimental implementations use the deprecated constant IDBTransaction.READ_WRITE instead of &#34;readwrite&#34;.
</span></span></span><span class=line><span class=cl><span class=c1>// In case you want to support such an implementation, you can just write:
</span></span></span><span class=line><span class=cl><span class=c1>// var transaction = db.transaction([&#34;customers&#34;], IDBTransaction.READ_WRITE);
</span></span></span></code></pre></td></tr></table></div></div><ul><li>呼叫 <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase#transaction target=_blank rel=noopener>transaction()</a> 方法會回傳一個交易物件。<code>transaction()</code>第一個接受參數代表交易涵蓋的物件存檔，雖然傳入空陣列會讓交易涵蓋所有物件存檔，但請不要這麼做，因為根據正式標準傳入空陣列應該要導致InvalidAccessError錯誤；第二個參數代表交易種類，不傳入的話預設為讀取交易，本例要寫入資料庫所以傳入讀寫(&ldquo;readwrite&rdquo;)。</li><li>交易的生命週期和事件循環關係密切。當我們發起交易又回到事件循環中後，如果忽略，那麼交易將轉成結束，唯一保持交易存活的方法是在交易上發出請求；當請求完成後我們會收到DOM事件，假設請求結果成功，我們可以在事件的回呼函數(callback中)繼續進行交易，反之，如果我們沒有繼續進行交易，那麼交易將結束，也就是說只要尚有未完成請求的話，交易就會繼續存活，如果收到TRANSACTION_INACTIVE_ERR錯誤那便意謂著交易早已結束，我們錯過了繼續進行交易的機會。</li><li>交易能收到三種事件: <code>錯誤(error)</code>、<code>中斷(abort)</code>以及<code>完成(complete)</code>，其中錯誤事件會向上傳遞，所以任何一個交易下轄的請求產生錯誤事件，該交易都會收到。如果交易收到錯誤事件時，瀏覽器預設行為會中斷交易，除非我們有在錯誤事件上呼叫<code>preventDefault()</code>阻擋瀏覽器預設行動，否則整筆交易都將取消、復原，這樣的設計告訴我們必須要思考如何處裡錯誤，或者說如果對每一個錯誤進行處裡過於麻煩，那麼至少加入一個概括性的錯誤處理器也是可以。只要不處裡錯誤或呼叫<code>abort()</code>，交易將取消、復原，然後中斷事件接著觸發，反之，當所有請求都完成後，我們會收到一個完成事件，所以說如果我們同時發起多項請求時，可以只追蹤單一交易而非個別請求，這樣會大大減輕我們的負擔。</li></ul><h5 id=有了交易之後便能夠從中取得物件存檔有了物件存檔便能夠新增資料請注意唯有在建立交易時指定的物件存檔能夠取得>有了交易之後便能夠從中取得物件存檔，有了物件存檔便能夠新增資料(請注意唯有在建立交易時指定的物件存檔能夠取得)。</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Do something when all the data is added to the database.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>transaction</span><span class=p>.</span><span class=nx>oncomplete</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;All done!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>transaction</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Don&#39;t forget to handle errors!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>objectStore</span> <span class=o>=</span> <span class=nx>transaction</span><span class=p>.</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=k>in</span> <span class=nx>customerData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>objectStore</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>customerData</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// event.target.result == customerData[i].ssn;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>呼叫 <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore#add%28%29 target=_blank rel=noopener>add()</a> 方法可以加入一筆新資料，呼叫後會回傳一個<a class=link href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest?redirectlocale=en-US&amp;redirectslug=IndexedDB%2FIDBRequest" target=_blank rel=noopener>IDBRequest</a>物件，即為上方範例中的request，如果新增成功，request的成功事件會被觸發，而成功事件物件中有一個result屬性，這個result值剛好就等於新資料的資料鍵，所以說上方範例中的event.target.result剛好就等於顧客的ssn值(因為我們用ssn屬性作為資料鍵路徑)。請注意add方法只在當物件存檔中沒有相同資料鍵資料存在時有用，如果想要更動或是直接覆蓋現存資料請呼叫put方法。</li></ul><h3 id=5-移除資料>5. 移除資料</h3><h5 id=移除資料十分容易>移除資料十分容易：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;customers&#34;</span><span class=p>],</span> <span class=s2>&#34;readwrite&#34;</span><span class=p>).</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>).</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;444-44-4444&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// It&#39;s gone!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=6-讀取資料>6. 讀取資料</h3><h5 id=要取資料庫內的資料有數種途徑第一個最簡單的途徑就是提供資料鍵呼叫-gethttpsdevelopermozillaorgen-usdocswebapiidbobjectstoreget-方法取得資料>要取資料庫內的資料有數種途徑，第一個最簡單的途徑就是提供資料鍵，呼叫 <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore#get%28%29 target=_blank rel=noopener>get()</a> 方法取得資料：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>transaction</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;customers&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>objectStore</span> <span class=o>=</span> <span class=nx>transaction</span><span class=p>.</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>objectStore</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;444-44-4444&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle errors!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Do something with the request.result!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Name for SSN 444-44-4444 is &#34;</span> <span class=o>+</span> <span class=nx>request</span><span class=p>.</span><span class=nx>result</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=假設我們把錯誤處理放在資料庫層級我們可以再縮短上面的程式碼如下>假設我們把錯誤處理放在資料庫層級，我們可以再縮短上面的程式碼如下：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>).</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;444-44-4444&#34;</span><span class=p>).</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Name for SSN 444-44-4444 is &#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>呼叫 transcation 方法而不指定模式會開啟讀取(readonly)模式，接著取得我們的目標物件存檔，輸入目標資料的資料鍵，呼叫get方法取得請求物件，然後在請求物件上註冊成功事件處理器，當作業成功後，成功事件會觸發，成功事件的物件中含有請求物件(event.target如上述範例)，請求物件中含有請求結果(event.target.result如上述範例)。</li></ul><h3 id=7-使用指標cursor>7. 使用指標(Cursor)</h3><h5 id=使用get方法需要知道資料鍵如果想要一一存取物件存檔中的資料我們可以利用指標>使用get方法需要知道資料鍵，如果想要一一存取物件存檔中的資料，我們可以利用指標：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>objectStore</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>).</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;customers&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>objectStore</span><span class=p>.</span><span class=nx>openCursor</span><span class=p>().</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Name for SSN &#34;</span> <span class=o>+</span> <span class=nx>cursor</span><span class=p>.</span><span class=nx>key</span> <span class=o>+</span> <span class=s2>&#34; is &#34;</span> <span class=o>+</span> <span class=nx>cursor</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>cursor</span><span class=p>.</span><span class=k>continue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;No more entries!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore#openCursor%28%29 target=_blank rel=noopener>openCursor</a> 方法第一個參數用來接受資料鍵範圍物件來限制存取資料範圍，第二個參數用來指定存取進行方向，像上面的範例程式便是以資料鍵由小到大之方向存取資料；呼叫openCursor方法後一樣會回傳一個請求物件，成功時成功事件會觸發，不過這裡有些地方要特別注意，當成功事件處裡函數被喚起時，指標物件(cursor)會存放在result屬性內(亦即上述event.target.result)，cursor物件下有兩個屬性，key屬性是資料鍵，value屬性是資料值，如果要取得下一份資料就呼叫cursor的continue()方法，然後cursor物件就會指向下一份資料，當沒有資料時，cursor會是undefined，當請求一開始便找沒有資料，result屬性也會是undefined。</li></ul><h5 id=以下用cursor存取一遍資料後放在陣列中的作法相當常見>以下用cursor存取一遍資料後放在陣列中的作法相當常見：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>customers</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>objectStore</span><span class=p>.</span><span class=nx>openCursor</span><span class=p>().</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>customers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>cursor</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>cursor</span><span class=p>.</span><span class=k>continue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Got all customers: &#34;</span> <span class=o>+</span> <span class=nx>customers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><span class=focus>Warning: 以下範例不是IndexedDB標準!</span></p><h5 id=mozilla瀏覽器自己做了一個-getall-方法來方便一次取得所有cursor下的資料值這個方法相當方便不過請小心未來它有可能會消失以下程式碼的效果和上面的一樣>Mozilla瀏覽器自己做了一個 <code>getAll()</code> 方法來方便一次取得所有cursor下的資料值，這個方法相當方便，不過請小心未來它有可能會消失。以下程式碼的效果和上面的一樣：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>objectStore</span><span class=p>.</span><span class=nx>getAll</span><span class=p>().</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Got all customers: &#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>一一檢查cursor的value屬性較不利性能表現，因為物件是被動一一建立，然而呼叫 <code>getAll()</code>，Gecko一定要一次建立所有物件，所以如果想要一次取得所有物件的資料值陣列使用 <code>getAll()</code> 比較好，如果想要一一檢查每筆資料則請利用cursor的方法。</li></ul><h3 id=8-使用索引>8. 使用索引</h3><ul><li>利用一定唯一的ssn碼作為資料鍵相當合乎邏輯(隱私權的問題先擱置一放，不在本文探討範圍)。不過當我們想要查詢使用者的名字的時候，如果沒有索引就需要一一檢查每一筆資料，十分沒有效率，所以我們可以建立name的索引。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>index</span> <span class=o>=</span> <span class=nx>objectStore</span><span class=p>.</span><span class=nx>index</span><span class=p>(</span><span class=s2>&#34;name&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>index</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;Donna&#34;</span><span class=p>).</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Donna&#39;s SSN is &#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>.</span><span class=nx>ssn</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>因為 name 不是唯一值，所以可能會有多筆資料符合"Donna"名字，此時呼叫 <code>get()</code> 會取得資料鍵最小值的資料。</li></ul><h3 id=9-設定指標查詢範圍和方向>9. 設定指標查詢範圍和方向</h3><ul><li>如果想要限定指標查詢範圍，那麼在乎叫 <code>openCursor()</code> 或 <code>openKeyCursor()</code> 時第一個參數要傳入 <a class=link href=https://developer.mozilla.org/en/IndexedDB/IDBKeyRange target=_blank rel=noopener>IDBKeyRange</a> 物件以限制範圍。IDBKeyRange物件能夠只聚焦在單一資料鍵上或者一段上下限區間；上下限區間可以是封閉(含界限)或開放(不含界限)，請看以下範例：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Only match &#34;Donna&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>singleKeyRange</span> <span class=o>=</span> <span class=nx>IDBKeyRange</span><span class=p>.</span><span class=nx>only</span><span class=p>(</span><span class=s2>&#34;Donna&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Match anything past &#34;Bill&#34;, including &#34;Bill&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>lowerBoundKeyRange</span> <span class=o>=</span> <span class=nx>IDBKeyRange</span><span class=p>.</span><span class=nx>lowerBound</span><span class=p>(</span><span class=s2>&#34;Bill&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Match anything past &#34;Bill&#34;, but don&#39;t include &#34;Bill&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>lowerBoundOpenKeyRange</span> <span class=o>=</span> <span class=nx>IDBKeyRange</span><span class=p>.</span><span class=nx>lowerBound</span><span class=p>(</span><span class=s2>&#34;Bill&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Match anything up to, but not including, &#34;Donna&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>upperBoundOpenKeyRange</span> <span class=o>=</span> <span class=nx>IDBKeyRange</span><span class=p>.</span><span class=nx>upperBound</span><span class=p>(</span><span class=s2>&#34;Donna&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Match anything between &#34;Bill&#34; and &#34;Donna&#34;, but not including &#34;Donna&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>boundKeyRange</span> <span class=o>=</span> <span class=nx>IDBKeyRange</span><span class=p>.</span><span class=nx>bound</span><span class=p>(</span><span class=s2>&#34;Bill&#34;</span><span class=p>,</span> <span class=s2>&#34;Donna&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>index</span><span class=p>.</span><span class=nx>openCursor</span><span class=p>(</span><span class=nx>boundKeyRange</span><span class=p>).</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do something with the matches.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cursor</span><span class=p>.</span><span class=k>continue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=有時候我們會想要由大到小查看資料而非預設由小到大方向傳入第二個prev字串便能做到>有時候我們會想要由大到小查看資料而非預設由小到大方向，傳入第二個"prev"字串便能做到：</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>objectStore</span><span class=p>.</span><span class=nx>openCursor</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=s2>&#34;prev&#34;</span><span class=p>).</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do something with the entries.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cursor</span><span class=p>.</span><span class=k>continue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=由於name索引不具唯一性所以一個名字下可能會出現多筆資料此時如果想要避開這多筆資料請傳入nextunique或prevunique做為第二個方向參數當傳入之後如一個名字下遇到多筆資料則只有資料鍵最小的資料會被回傳>由於"name"索引不具唯一性，所以一個名字下可能會出現多筆資料，此時如果想要避開這多筆資料，請傳入"nextunique"或"prevunique"做為第二個方向參數，當傳入之後，如一個名字下遇到多筆資料，則只有資料鍵最小的資料會被回傳。</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>index</span><span class=p>.</span><span class=nx>openKeyCursor</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=s2>&#34;nextunique&#34;</span><span class=p>).</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cursor</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Do something with the entries.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cursor</span><span class=p>.</span><span class=k>continue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>關於可傳入的方向參數，請參考<a class=link href="https://developer.mozilla.org/en-US/docs/Web/API/IDBCursor?redirectlocale=en-US&amp;redirectslug=IndexedDB%2FIDBCursor#Constants" target=_blank rel=noopener>IDBCursor</a>常數。</p><hr><h2 id=安全性>安全性</h2><ul><li>IndexedDB遵守<a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Same_origin_policy_for_JavaScript target=_blank rel=noopener>同源政策</a>，所以它綁定創建它的來源網站，其他來源網站無法存取。</li><li>就像對載入 <a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/HTML/Element/frame target=_blank rel=noopener>&lt;frame></a> 和 <a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/HTML/Element/frame target=_blank rel=noopener>&lt;iframe></a> 網頁的第三方cookie所設下的安全性和隱私權考量限制，IndexedDB無法在載入 <a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/HTML/Element/frame target=_blank rel=noopener>&lt;frame></a> 和 <a class=link href=https://developer.mozilla.org/zh-TW/docs/Web/HTML/Element/frame target=_blank rel=noopener>&lt;iframe></a> 網頁上運作，詳情請見 <a class=link href="https://bugzilla.mozilla.org/show_bug.cgi?id=595307" target=_blank rel=noopener>bug 595307</a>。</li></ul><hr><h2 id=瀏覽器關閉風險>瀏覽器關閉風險</h2><h5 id=當瀏覽器關閉例如使用者按下關閉鈕任何未完成indexeddb交易都將默默中止這些交易不會完成錯誤事件也不會觸發既然瀏覽器可能隨時被關閉我們無法完全指望任何特定交易一定會完成或是依賴錯誤事件做出相應處理針對這種狀況我們需要注意>當瀏覽器關閉，例如使用者按下關閉鈕，任何未完成IndexedDB交易都將默默中止，這些交易不會完成，錯誤事件也不會觸發。既然瀏覽器可能隨時被關閉，我們無法完全指望任何特定交易一定會完成，或是依賴錯誤事件做出相應處理，針對這種狀況，我們需要注意：</h5><ol><li>每一筆交易結束後都應該要保持資料庫完整性，例如說，有一串使用者編輯項目清單正要存入資料庫，我們如果先在一個交易中清除舊清單，然後在另一個交易中存入新清單，那就會面臨到清除完就清單後，新清單存入交易還來不及回存，瀏覽器就關閉的風險，而這個時候資料庫裡面的清單資料將消失。所以比較好的做法應該是在同一筆交易中完成清除舊清單和存入新清單。</li><li>永遠不要在unload事件中執行資料庫交易，因為如果unload事件是觸發在瀏覽器關閉下，任何資料庫交易都不會發生，或許，瀏覽器(或分頁)打開時讀取資料庫，更新資料庫當使用者編輯資料，當瀏覽器(或分頁)關閉時儲存資料這樣的做法比較直覺，不過資料庫的操作是非同步進行地，所以瀏覽器關閉的執行會在資料庫操作前發生，進而中斷後續非同步的資料庫交易，所以在unload事件中執行資料庫交易是行不通地。</li></ol><ul><li>事實上不論瀏覽器是否正常關閉，都沒有任何方法保證IndexedDB交易能夠順利完成，請見 <a class=link href="https://bugzilla.mozilla.org/show_bug.cgi?id=870645" target=_blank rel=noopener>bug 870645</a>。</li></ul><hr><h2 id=範例練習將聊天室推播訊息寫進-indexeddb>範例練習：將聊天室推播訊息寫進 IndexedDB</h2><ul><li>建立db.js，並將操作 IndexedDB 整合至檔案中。</li><li>vue檔引入db.js，並一次僅撈最新50筆資料。</li></ul><h5 id=dbjs>db.js</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 回傳是否支援 IndexedDB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>isSupportDB</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>indexedDB</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>indexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>webkitIndexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>mozIndexedDB</span> <span class=o>||</span> <span class=nb>window</span><span class=p>.</span><span class=nx>msIndexedDB</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>!!</span><span class=nx>indexedDB</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 打開or建立DB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>openDB</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>indexedDB</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s2>&#34;ChatDB&#34;</span><span class=p>)</span> <span class=c1>// 打開or建立聊天室DB
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;idb create fail&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>reject</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;idb create success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>DBObject</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>result</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>DBObject</span><span class=p>)</span> <span class=c1>// 成功後返回DB物件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>request</span><span class=p>.</span><span class=nx>onupgradeneeded</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 若版本已升級則重新建立DB物件，並返回DB物件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>DBObject</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span>
</span></span><span class=line><span class=cl>            <span class=nx>DBObject</span><span class=p>.</span><span class=nx>createObjectStore</span><span class=p>(</span><span class=s2>&#34;chatData&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>keyPath</span><span class=o>:</span> <span class=s2>&#34;index&#34;</span><span class=p>,</span> <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>DBObject</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 取歷史聊天紀錄最新50筆
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>getHistory</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>objectStore</span> <span class=o>=</span> <span class=nx>DBObject</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;chatData&#34;</span><span class=p>],</span> <span class=s2>&#34;readonly&#34;</span><span class=p>).</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;chatData&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>getKey</span> <span class=o>=</span> <span class=nx>objectStore</span><span class=p>.</span><span class=nx>getAllKeys</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>getKey</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nx>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>getKey</span><span class=p>.</span><span class=nx>result</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=nx>num</span> <span class=o>*</span> <span class=mi>50</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;</span> <span class=nx>getKey</span><span class=p>.</span><span class=nx>result</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=nx>num</span> <span class=o>*</span> <span class=mi>50</span> <span class=o>-</span> <span class=mi>50</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>getItem</span> <span class=o>=</span> <span class=nx>objectStore</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>getKey</span><span class=p>.</span><span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=nx>getItem</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>result</span><span class=p>.</span><span class=nx>unshift</span><span class=p>(</span><span class=nx>getItem</span><span class=p>.</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 一次撈全部資料
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// const request = DBObject.transaction([&#34;chatData&#34;], &#34;readonly&#34;).objectStore(&#34;chatData&#34;).getAll()
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// request.onsuccess = () =&gt; {
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//    resolve(request.result)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 收到推播將訊息寫入idb
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>addToDB</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>DBObject</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;chatData&#34;</span><span class=p>],</span> <span class=s2>&#34;readwrite&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>.</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;chatData&#34;</span><span class=p>).</span><span class=nx>add</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//数据写入成功的回调
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>request</span><span class=p>.</span><span class=nx>onsuccess</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 清除idb聊天紀錄
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>clearDB</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>DBObject</span><span class=p>.</span><span class=nx>transaction</span><span class=p>([</span><span class=s2>&#34;chatData&#34;</span><span class=p>],</span> <span class=s2>&#34;readwrite&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>.</span><span class=nx>objectStore</span><span class=p>(</span><span class=s2>&#34;chatData&#34;</span><span class=p>).</span><span class=nx>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=chatroomvue>chatroom.vue</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=nx>as</span> <span class=nx>idb</span> <span class=nx>from</span> <span class=s2>&#34;@/utils/db&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>msgData</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nx>historyRange</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>mounted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>getHistory</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>historyRange</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=mi>500</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>methods</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>getHistory</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>idb</span><span class=p>.</span><span class=nx>isSupportDB</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 若支援則開啟DB，並待回傳後撈資料
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>idb</span><span class=p>.</span><span class=nx>openDB</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>idb</span><span class=p>.</span><span class=nx>getHistory</span><span class=p>(</span><span class=nx>num</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>result</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>msgData</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 未有資料時直接定義
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>this</span><span class=p>.</span><span class=nx>msgData</span> <span class=o>=</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nx>result</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// 將撈到的資料由前塞入msgData
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=k>this</span><span class=p>.</span><span class=nx>msgData</span><span class=p>.</span><span class=nx>unshift</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=p>})</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=k>this</span><span class=p>.</span><span class=nx>historyRange</span><span class=o>++</span>
</span></span><span class=line><span class=cl>                        <span class=p>},</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>add</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>idb</span><span class=p>.</span><span class=nx>addToDB</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>clearDB</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>idb</span><span class=p>.</span><span class=nx>clearDB</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=https://wayne-blog.com/tags/indexeddb/>indexedDB</a>
<a href=https://wayne-blog.com/tags/web-browser/>web-browser</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-blog-wayne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Wayne's blog | 偉恩的部落格 | 技術博客</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://wayne-blog.com/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>"serviceWorker"in navigator&&(console.log("Check service worker register?"),navigator.serviceWorker.register("./service-worker.js").then(function(){console.log("service worker registed.")}).catch(function(e){console.log("service worker registed fail. This happened: ",e)}));function toggleBtnScrollTop(){let t=document.documentElement.scrollTop||document.body.scrollTop;const e=document.getElementById("btnScrollTop");if(t){e&&!e.classList.contains("show")&&e.classList.add("show");return}e&&e.classList.contains("show")&&e.classList.remove("show")}window.addEventListener("scroll",toggleBtnScrollTop),document.addEventListener("DOMContentLoaded",toggleBtnScrollTop);function clickToScrollTop(){window.scrollTo({top:0,behavior:"smooth"})}function clickToMessenger(){window.open("//m.me/100278986238046","_blank")}</script><button id=btnScrollTop onclick=clickToScrollTop() title=回到頁頂>
<img src=https://wayne-blog.com/img/top_huf0c1dc16de3f1372c70e7aced5d60e6d_660_30x0_resize_box_3.png alt=scroll-top></button>
<button id=btnMessenger onclick=clickToMessenger() title="Facebook Messenger">
<img src=https://wayne-blog.com/img/messenger_hu3f63590c9d474cc4c51a145f9812597b_7669_50x0_resize_box_3.png alt="facebook messenger"></button></body></html>